<!-- Ensure this is after: <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script> -->
<script src="common.js"></script>

<script>
  // Signup form wiring (assumes input IDs: su-email, su-password, su-fullname optional)
  (function(){
    const btn = document.getElementById('btn-signup') || document.getElementById('signup-submit');
    if (!btn) return console.warn('Signup button not found, skip signup wiring');

    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = (document.getElementById('su-email') || {}).value || (document.querySelector('[name="email"]')||{}).value;
      const password = (document.getElementById('su-password') || {}).value || (document.querySelector('[name="password"]')||{}).value;
      const full = (document.getElementById('su-fullname') || {}).value || (document.getElementById('su-name')||{}).value || null;

      if (!email || !password) return alert('Enter email & password');
      btn.disabled = true;
      btn.innerText = 'Signing up...';

      const { data, error } = await Common.signUp(email, password);
      if (error) {
        btn.disabled = false;
        btn.innerText = 'Sign up';
        return alert('Signup error: ' + error.message);
      }

      // try to sign in automatically (if allowed)
      try {
        await Common.signIn(email, password);
      } catch (e) { /* ignore */ }

      // upsert a minimal profile row (id = user.id). We wait for getUser to be available.
      const user = await Common.getUser();
      if (user && full) {
        await Common.upsertProfile({ id: user.id, full_name: full });
      }

      // redirect to home
      window.location.href = 'home.html';
    });
  })();
</script>
