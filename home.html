<!-- Add this CSS into <head> or near your existing styles to style the rendered resume -->
<style id="resume-styles">
/* Minimal resume styling modeled after your PDF example */
.resume {
  background: #071226;
  color: #e6eef2;
  padding: 22px;
  border-radius: 6px;
  font-family: 'Arial', sans-serif;
  line-height: 1.3;
}
.resume .header { display:flex; justify-content:space-between; align-items:flex-start; gap:12px; }
.resume h1 { margin:0; font-size:22px; color:#fff; }
.resume h2 { margin:4px 0 12px 0; font-size:14px; color:#bfe7ea; font-weight:600; }
.resume .contact { text-align:right; font-size:13px; color:#bcd3d8; }
.section { margin-top:16px; }
.section h3 { margin:0 0 8px 0; font-size:15px; border-bottom:1px solid rgba(190,220,225,0.06); padding-bottom:6px; color:#cfe8f0; }
.exp-item { margin:10px 0; }
.exp-item .top { display:flex; justify-content:space-between; align-items:flex-start; gap:8px; }
.exp-item .role { font-weight:700; color:#e8f6f7; }
.exp-item .company { color:#bcd3d8; }
.exp-item .dates { color:#9fb1b6; font-size:13px; }
.exp-item ul { margin:8px 0 0 18px; }
.kv { display:inline-block; margin-right:10px; color:#bcd3d8; font-size:13px; }
.ats { margin-top:8px; font-size:13px; color:#cfe8f0; }
</style>

<script>
/*
  New buildPromptJSON: builds a deterministic instruction asking for JSON.
  New callLLMAndRender: calls OpenAI, parses JSON, and renders HTML using renderTailoredResume(jsonObj).
  Replace your previous generate button handler with the handler below (or simply update existing handler).
*/

async function buildPromptJSON(jobDescription) {
  // gather user info from supabase
  const { data: { user } } = await supabaseClient.auth.getUser()
  if (!user) throw new Error('Not authenticated')

  // Get profile, exps, edus
  const [profileRes, expsRes, edusRes] = await Promise.all([
    supabaseClient.from('profiles').select('*').eq('id', user.id).single(),
    supabaseClient.from('experiences').select('*').eq('user_id', user.id).order('created_at', { ascending:false }),
    supabaseClient.from('education').select('*').eq('user_id', user.id).order('created_at', { ascending:false })
  ])

  const profile = profileRes?.data || {}
  const exps = expsRes?.data || []
  const edus = edusRes?.data || []

  // Build a compact plain-text resume snapshot for the model
  let resumeSnapshot = `Name: ${profile.full_name || ''}\nLocation: ${profile.location || ''}\nPhone: ${profile.phone || ''}\nEmail: ${user.email}\nLinkedIn: ${profile.linkedin || ''}\nGitHub: ${profile.github || ''}\n\nExperience:\n`
  for (const e of exps) {
    resumeSnapshot += `- ${e.title || ''} at ${e.company || ''} (${e.start_date || ''} - ${e.end_date || 'Present'})\n`
    if (e.bullets) resumeSnapshot += e.bullets.split('\n').map(b => `  * ${b}`).join('\n') + '\n'
  }
  resumeSnapshot += '\nEducation:\n'
  for (const d of edus) {
    resumeSnapshot += `- ${d.degree || ''} at ${d.institution || ''} (${d.start_date || ''} - ${d.end_date || ''})\n`
  }

  // Prompt: ask for JSON only (no extra text)
  const instruction = `
You are an expert resume writer and ATS specialist. Based on the user's resume snapshot and the Job Description below, produce a JSON object only (no additional explanation, no markdown).
The JSON must match this exact schema:

{
  "name": "Full Name",
  "title": "Target Job Title (1-4 words)",
  "contact": { "location": "...", "phone": "...", "email": "...", "linkedin": "...", "github": "..." },
  "summary": "2-4 sentence targeted summary (include top keywords from JD)",
  "experience": [
    {
      "title": "Senior DevOps Engineer",
      "company": "Acme",
      "dates": "Aug 2021 - May 2023",
      "bullets": ["Action-oriented accomplishment 1", "Accomplishment 2", "Accomplishment 3"]
    },
    ...
  ],
  "education": [
    { "degree":"B.Tech Mechanical Engineering", "institution":"XYZ", "dates":"2014 - 2018" }
  ],
  "skills": ["skill1","skill2","..."],
  "certifications": ["cert1","cert2"],
  "ats_keywords": ["keyword1","keyword2","..."]
}

Rules:
- Return valid JSON only (top-level object). No commentary, no explanations.
- Use 3-6 bullets for each relevant experience role, rewrite bullets as accomplishment-driven and include keywords from the Job Description.
- Make summary concise and tailored to the Job Description.
- Infer 'title' from the Job Description and user's history.
- If information is missing, provide reasonable inferred text but keep it truthful.

User resume snapshot:
${resumeSnapshot}

Job Description:
${jobDescription}

Return the JSON now.
  `.trim()

  return instruction
}

async function callLLMAndRender(promptText) {
  const key = localStorage.getItem('user_llm_api_key')
  if (!key) throw new Error('Missing API key. Save your API key first.')
  llmStatus.textContent = 'Calling LLM... (this may take 10–20s)'
  llmOutput.textContent = ''

  const body = {
    model: 'gpt-4o-mini',    // change if needed
    messages: [{ role: 'user', content: promptText }],
    temperature: 0.1,
    max_tokens: 1400
  }

  const resp = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
    body: JSON.stringify(body)
  })

  if (!resp.ok) {
    const text = await resp.text()
    throw new Error(`LLM error ${resp.status}: ${text}`)
  }

  const data = await resp.json()
  const content = data?.choices?.[0]?.message?.content || data?.choices?.[0]?.text
  if (!content) throw new Error('No content from LLM')

  // Try to parse JSON only — model was instructed to return JSON
  let parsed = null
  try {
    // Some models may return surrounding backticks; remove them
    const cleaned = content.trim().replace(/^```json\s*/,'').replace(/```$/,'').trim()
    parsed = JSON.parse(cleaned)
  } catch (err) {
    // If parse failed, show model output for debugging
    llmStatus.textContent = 'LLM returned non-JSON. See console.'
    llmOutput.textContent = content
    console.error('Failed to parse JSON from LLM output:', content, err)
    throw new Error('Failed to parse JSON from LLM output (check console)')
  }

  llmStatus.textContent = 'Rendering tailored resume...'
  renderTailoredResume(parsed)
  llmStatus.textContent = 'Done.'
}

// Render JSON into HTML that mirrors the PDF example
function renderTailoredResume(obj) {
  // build header
  const container = document.getElementById('llm-output')
  container.innerHTML = '' // clear
  const wrapper = document.createElement('div')
  wrapper.className = 'resume'

  // Header: name/title + contact on right
  const header = document.createElement('div'); header.className = 'header'
  const left = document.createElement('div')
  const name = document.createElement('h1'); name.textContent = obj.name || ''
  const title = document.createElement('h2'); title.textContent = obj.title || ''
  left.appendChild(name); left.appendChild(title)
  const right = document.createElement('div'); right.className='contact'
  if (obj.contact) {
    const c = obj.contact
    if (c.location) right.appendChild(Object.assign(document.createElement('div'),{textContent:c.location}))
    const phoneLine = document.createElement('div'); phoneLine.textContent = (obj.contact.phone || '') + (obj.contact.email ? ` • ${obj.contact.email}` : '')
    right.appendChild(phoneLine)
    if (c.linkedin) right.appendChild(Object.assign(document.createElement('div'),{innerHTML:`<a href="${c.linkedin}" target="_blank" style="color:#9fe9f0">${c.linkedin}</a>`}))
  }
  header.appendChild(left); header.appendChild(right)
  wrapper.appendChild(header)

  // Summary
  if (obj.summary) {
    const ssec = document.createElement('div'); ssec.className='section'
    ssec.innerHTML = `<h3>Summary</h3><div style="margin-top:8px">${escapeHtml(obj.summary)}</div>`
    wrapper.appendChild(ssec)
  }

  // Experience
  if (Array.isArray(obj.experience) && obj.experience.length) {
    const esec = document.createElement('div'); esec.className='section'
    esec.innerHTML = '<h3>Experience</h3>'
    for (const e of obj.experience) {
      const item = document.createElement('div'); item.className='exp-item'
      const top = document.createElement('div'); top.className='top'
      const leftTop = document.createElement('div')
      const role = document.createElement('div'); role.className='role'; role.textContent = e.title || ''
      const company = document.createElement('div'); company.className='company'; company.textContent = e.company || ''
      leftTop.appendChild(role); leftTop.appendChild(company)
      const dates = document.createElement('div'); dates.className='dates'; dates.textContent = e.dates || ''
      top.appendChild(leftTop); top.appendChild(dates)
      item.appendChild(top)
      if (Array.isArray(e.bullets) && e.bullets.length) {
        const ul = document.createElement('ul')
        for (const b of e.bullets) {
          const li = document.createElement('li'); li.innerHTML = escapeHtml(b)
          ul.appendChild(li)
        }
        item.appendChild(ul)
      }
      esec.appendChild(item)
    }
    wrapper.appendChild(esec)
  }

  // Education
  if (Array.isArray(obj.education) && obj.education.length) {
    const esec = document.createElement('div'); esec.className='section'
    esec.innerHTML = '<h3>Education</h3>'
    for (const d of obj.education) {
      const div = document.createElement('div'); div.style.marginTop='8px'
      const main = document.createElement('div'); main.innerHTML = `<strong>${escapeHtml(d.degree || '')}</strong> — ${escapeHtml(d.institution || '')}`
      const dates = document.createElement('div'); dates.className='dates'; dates.textContent = d.dates || ''
      div.appendChild(main); div.appendChild(dates)
      if (d.notes) {
        const p = document.createElement('div'); p.style.marginTop='6px'; p.textContent = d.notes
        div.appendChild(p)
      }
      esec.appendChild(div)
    }
    wrapper.appendChild(esec)
  }

  // Skills & Certifications
  const rightColumnItems = []
  if (Array.isArray(obj.skills) && obj.skills.length) {
    const s = document.createElement('div'); s.className='section'; s.innerHTML = '<h3>Skills</h3>'
    s.innerHTML += `<div style="margin-top:8px">${obj.skills.map(x => `<span class="kv">${escapeHtml(x)}</span>`).join(' ')}</div>`
    wrapper.appendChild(s)
  }
  if (Array.isArray(obj.certifications) && obj.certifications.length) {
    const c = document.createElement('div'); c.className='section'; c.innerHTML = '<h3>Certifications</h3>'
    c.innerHTML += `<div style="margin-top:8px">${obj.certifications.map(x => `<div class="kv">${escapeHtml(x)}</div>`).join('')}</div>`
    wrapper.appendChild(c)
  }

  if (Array.isArray(obj.ats_keywords) && obj.ats_keywords.length) {
    const a = document.createElement('div'); a.className='section'
    a.innerHTML = '<h3>ATS keywords</h3><div class="ats">' + obj.ats_keywords.map(k => escapeHtml(k)).join(' • ') + '</div>'
    wrapper.appendChild(a)
  }

  container.appendChild(wrapper)
}

// small helper like earlier
function escapeHtml(s) { if (!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

/* Hook up the Generate button to use the new functions.
   Replace any old handler you had previously.
*/
document.getElementById('btn-generate').onclick = async () => {
  try {
    const jd = document.getElementById('job-desc').value.trim()
    if (!jd) return alert('Paste a job description first.')
    llmStatus.textContent = 'Preparing prompt...'
    const prompt = await buildPromptJSON(jd)
    await callLLMAndRender(prompt)
  } catch (err) {
    console.error(err)
    alert('Error: ' + (err.message || err))
    llmStatus.textContent = 'Error: ' + (err.message || '')
  }
}
</script>
