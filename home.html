<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Resume Builder — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: Arial, Helvetica, sans-serif; max-width:900px; margin:2rem auto; padding:1rem; color:#f1f1f1; background:#0f1720; }
    .card { background:#0b1220; border:1px solid #172033; padding:16px; border-radius:8px; margin-bottom:12px; }
    input, button, textarea {
      display:block; width:100%; margin:8px 0; padding:10px;
      border-radius:6px; border:1px solid #233040; background:#071226; color:#fff;
      box-sizing:border-box;
    }
    button { cursor:pointer; background:#0ea5a4; color:#012; border:0; font-weight:600; }
    .row { display:flex; gap:8px; }
    label { font-weight:600; color:#cfe8f0; }
    small { color:#9aa7b2; }
    hr { border:none; border-top:1px solid #233040; margin:20px 0; }
  </style>

  <!-- Supabase + common.js -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="common.js"></script>
</head>

<body>
<h1>Resume Builder — Dashboard</h1>

<div id="dashboard" class="card">
  <p>Logged in as <strong><span id="user-email"></span></strong></p>

  <div class="row" style="margin-bottom:12px;">
    <button id="btn-logout" style="flex:1;background:#ef4444;color:#fff;">Logout</button>
    <button id="btn-refresh" style="flex:1;background:#0ea5a4;color:#012;">Refresh</button>
  </div>

  <!-- PROFILE -->
  <h3>Your Profile</h3>
  <label>Full name</label><input id="full_name" />
  <label>Phone</label><input id="phone" />
  <label>Location</label><input id="location" />
  <label>LinkedIn</label><input id="linkedin" />
  <label>GitHub</label><input id="github" />
  <button id="btn-save-profile">Save Profile</button>

  <hr>

  <!-- EXPERIENCE -->
  <h3>Experience</h3>
  <label>Company</label><input id="exp-company" />
  <label>Title</label><input id="exp-title" />
  <label>Start</label><input id="exp-start" type="date" />
  <label>End</label><input id="exp-end" type="date" />
  <label>Bullets (newline separated)</label>
  <textarea id="exp-bullets" rows="4"></textarea>

  <div class="row">
    <button id="btn-add-exp" style="flex:1;">Add Experience</button>
    <button id="btn-refresh-exps" style="flex:1;background:#334155;color:#fff;">Refresh</button>
  </div>

  <div id="experiences-list"><small>No experiences yet.</small></div>

  <hr>

  <!-- EDUCATION -->
  <h3>Education</h3>
  <label>Institution</label><input id="edu-institution" />
  <label>Degree</label><input id="edu-degree" />
  <label>Start</label><input id="edu-start" type="date" />
  <label>End</label><input id="edu-end" type="date" />
  <label>Notes</label>
  <textarea id="edu-notes" rows="3"></textarea>

  <div class="row">
    <button id="btn-add-edu" style="flex:1;">Add Education</button>
    <button id="btn-refresh-edus" style="flex:1;background:#334155;color:#fff;">Refresh</button>
  </div>

  <div id="education-list"><small>No education yet.</small></div>

  <p id="status"></p>
</div>

<!-- AI SECTION -->
<div class="card">
  <h3>AI Tailoring (user API key)</h3>
  <label>OpenAI API key</label>
  <input id="user-api-key" placeholder="sk-..." />
  <div class="row">
    <button id="btn-save-key">Save Key</button>
    <button id="btn-clear-key" style="background:#ef4444;color:#fff;">Clear Key</button>
  </div>
  <small id="key-hint">Stored in browser only.</small>

  <hr>

  <label>Job Description</label>
  <textarea id="job-desc" rows="6"></textarea>

  <div class="row">
    <button id="btn-generate" style="flex:1;background:#06b6d4;">Generate</button>
    <button id="btn-copy-output" style="flex:1;background:#334155;color:#fff;">Copy</button>
  </div>

  <p id="llm-status"></p>
  <h4>Generated Resume</h4>
  <div id="llm-output" class="card" style="white-space:pre-wrap; max-height:400px; overflow:auto;"></div>
  <button id="btn-print">Print / Save as PDF</button>
</div>


<script>
/* -------------------- AUTH PROTECTION -------------------- */
const user = await requireAuth();
if (!user) return; // redirected
document.getElementById("user-email").textContent = user.email;


/* -------------------- PROFILE -------------------- */
async function loadProfile() {
  const { data } = await supabaseClient.from("profiles").select("*").eq("id", user.id).single();
  if (data) {
    full_name.value = data.full_name || "";
    phone.value = data.phone || "";
    location.value = data.location || "";
    linkedin.value = data.linkedin || "";
    github.value = data.github || "";
  }
}

btn-save-profile.onclick = async () => {
  status.textContent = "Saving...";
  const payload = {
    id: user.id,
    full_name: full_name.value || null,
    phone: phone.value || null,
    location: location.value || null,
    linkedin: linkedin.value || null,
    github: github.value || null,
  };
  const { error } = await supabaseClient.from("profiles").upsert(payload);
  status.textContent = error ? error.message : "Profile saved";
};

/* -------------------- EXPERIENCE -------------------- */
async function loadExperiences() {
  const { data } = await supabaseClient
    .from("experiences")
    .select("*")
    .eq("user_id", user.id)
    .order("created_at", { ascending: false });

  if (!data || data.length === 0) {
    experiences-list.innerHTML = "<small>No experiences yet.</small>";
    return;
  }

  experiences-list.innerHTML = data
    .map((e) => {
      const bullets = (e.bullets || "")
        .split("\n")
        .map((b) => `<li>${escapeHtml(b)}</li>`)
        .join("");
      return `
        <div class="card">
          <strong>${escapeHtml(e.title)}</strong> — ${escapeHtml(e.company)}
          <br><small>${e.start_date} — ${e.end_date || "Present"}</small>
          <ul>${bullets}</ul>
          <button onclick="deleteExp('${e.id}')" style="background:#ef4444;color:#fff;">Delete</button>
        </div>`;
    })
    .join("");
}

async function deleteExp(id) {
  await supabaseClient.from("experiences").delete().eq("id", id);
  loadExperiences();
}

btn-add-exp.onclick = async () => {
  const payload = {
    user_id: user.id,
    company: exp-company.value,
    title: exp-title.value,
    start_date: exp-start.value,
    end_date: exp-end.value,
    bullets: exp-bullets.value,
  };
  await supabaseClient.from("experiences").insert(payload);
  loadExperiences();
};

btn-refresh-exps.onclick = loadExperiences;

/* -------------------- EDUCATION -------------------- */
async function loadEducation() {
  const { data } = await supabaseClient
    .from("education")
    .select("*")
    .eq("user_id", user.id)
    .order("created_at", { ascending: false });

  if (!data || data.length === 0) {
    education-list.innerHTML = "<small>No education yet.</small>";
    return;
  }

  education-list.innerHTML = data
    .map((e) => `
      <div class="card">
        <strong>${escapeHtml(e.degree)}</strong> — ${escapeHtml(e.institution)}
        <br><small>${e.start_date} — ${e.end_date}</small>
        <p>${escapeHtml(e.notes)}</p>
        <button onclick="deleteEdu('${e.id}')" style="background:#ef4444;color:#fff;">Delete</button>
      </div>`)
    .join("");
}

async function deleteEdu(id) {
  await supabaseClient.from("education").delete().eq("id", id);
  loadEducation();
}

btn-add-edu.onclick = async () => {
  const payload = {
    user_id: user.id,
    institution: edu-institution.value,
    degree: edu-degree.value,
    start_date: edu-start.value,
    end_date: edu-end.value,
    notes: edu-notes.value,
  };
  await supabaseClient.from("education").insert(payload);
  loadEducation();
};

btn-refresh-edus.onclick = loadEducation;

/* -------------------- AI SECTION -------------------- */
apiKeyInput = document.getElementById("user-api-key");

// load saved key if present
if (getLLMKey()) {
  apiKeyInput.placeholder = "API key saved (hidden)";
  key-hint.textContent = "A key exists in localStorage.";
}

btn-save-key.onclick = () => {
  if (!apiKeyInput.value.trim()) return alert("Enter a key");
  saveLLMKey(apiKeyInput.value);
  apiKeyInput.value = "";
  key-hint.textContent = "Saved!";
};

btn-clear-key.onclick = () => {
  clearLLMKey();
  key-hint.textContent = "Cleared!";
};

// AI prompt builder
async function buildPrompt(jd) {
  const [prof, exps, edus] = await Promise.all([
    supabaseClient.from("profiles").select("*").eq("id", user.id).single(),
    supabaseClient.from("experiences").select("*").eq("user_id", user.id),
    supabaseClient.from("education").select("*").eq("user_id", user.id),
  ]);

  const p = prof.data || {};
  const e = exps.data || [];
  const d = edus.data || [];

  let text = `Name: ${p.full_name}\nLocation: ${p.location}\nPhone: ${p.phone}\nLinkedIn: ${p.linkedin}\nGitHub: ${p.github}\n\nExperience:\n`;

  e.forEach((x) => {
    text += `- ${x.title} at ${x.company} (${x.start_date}–${x.end_date || "Present"})\n`;
    if (x.bullets) text += x.bullets.split("\n").map((b) => `  • ${b}`).join("\n") + "\n";
  });

  text += "\nEducation:\n";
  d.forEach((x)=> text += `- ${x.degree} at ${x.institution} (${x.start_date}–${x.end_date})\n` );

  return `
You are an expert resume writer. Rewrite the user’s resume to match this job description:

${jd}

User data:
${text}

Return a polished ATS-friendly resume.
  `;
}

// LLM call
async function callLLM(prompt){
  const key = getLLMKey();
  if (!key) throw new Error("Missing API key");

  llm-status.textContent = "Generating…";
  const body = {
    model: "gpt-4o-mini",
    messages: [{ role: "user", content: prompt }],
    max_tokens: 1000,
    temperature: 0.2
  };

  const resp = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: { "Content-Type": "application/json", Authorization: `Bearer ${key}` },
    body: JSON.stringify(body),
  });

  if (!resp.ok) throw new Error(await resp.text());

  return (await resp.json()).choices[0].message.content;
}

btn-generate.onclick = async () => {
  try {
    const jd = job-desc.value.trim();
    if (!jd) return alert("Paste a job description");

    llm-status.textContent = "Preparing...";
    const prompt = await buildPrompt(jd);

    const out = await callLLM(prompt);
    llm-output.textContent = out;
    llm-status.textContent = "Done";
  } catch (e) {
    llm-status.textContent = "Error: " + e.message;
  }
};

btn-copy-output.onclick = async () => {
  if (!llm-output.textContent) return;
  await navigator.clipboard.writeText(llm-output.textContent);
  alert("Copied!");
};

btn-print.onclick = () => {
  const html = `<pre>${llm-output.textContent}</pre>`;
  const w = window.open("", "_blank");
  w.document.write(html);
  w.print();
};

/* INITIAL LOAD */
loadProfile();
loadExperiences();
loadEducation();
</script>
</body>
</html>
