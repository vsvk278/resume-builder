<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Resume Builder — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    html,body{height:100%;margin:0;font-family:Inter, Arial, sans-serif}
    body{background:linear-gradient(90deg,#0f3a37,#18c1b3);color:#fff;padding:36px;display:flex;align-items:flex-start;justify-content:center}
    .container{width:980px;max-width:96%}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .topbar h2{margin:0;font-size:20px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));padding:28px;border-radius:12px;box-shadow:0 30px 60px rgba(0,0,0,0.35)}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:24px}
    /* left large area reserved for illustration / profile summary */
    .left{min-height:420px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:8px;padding:28px}
    .illustration-placeholder{height:260px;background:rgba(255,255,255,0.03);border-radius:6px;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.5)}
    .profilepre{background:rgba(0,0,0,0.06);padding:12px;border-radius:6px;margin-top:18px;color:rgba(255,255,255,0.85);font-family:monospace;font-size:13px;white-space:pre-wrap;overflow:auto;max-height:160px}
    /* right form */
    .section{margin-bottom:18px}
    .section h3{margin:0 0 12px;font-weight:700}
    label{display:block;font-size:12px;color:rgba(255,255,255,0.9);margin-bottom:8px}
    input, textarea{width:100%;padding:10px;border-radius:8px;border:0;background:rgba(255,255,255,0.95);color:#0b2b27;font-weight:600}
    .row{display:flex;gap:12px}
    .row .col{flex:1}
    .small-btn{background:rgba(255,255,255,0.06);border-radius:8px;padding:8px 10px;border:0;color:#fff;cursor:pointer}
    .submit-wrap{text-align:right;margin-top:18px}
    .btn-primary{padding:12px 22px;border-radius:20px;background:linear-gradient(180deg,#0fb1a7,#06d1c0);border:0;color:#012;font-weight:700;cursor:pointer}
    .muted{color:rgba(255,255,255,0.75);font-size:13px;margin-top:12px}
    .top-actions button{margin-left:10px}
    .small-rounded{padding:8px 12px;border-radius:8px;border:0;background:#0b2b2a;color:#fff;cursor:pointer}
    /* responsive */
    @media (max-width:900px){
      .grid{grid-template-columns:1fr; padding:0}
      .submit-wrap{text-align:center}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <h2>Resume Builder — Home</h2>
      <div class="top-actions">
        <button id="btn-edit" class="small-rounded">Edit profile</button>
        <button id="btn-logout" class="small-rounded" style="background:#ff6b6b">Logout</button>
      </div>
    </div>

    <div class="card grid">
      <div class="left">
        <div class="illustration-placeholder">ILLUSTRATION</div>
        <div id="profileJSON" class="profilepre"></div>
      </div>

      <div class="right">
        <div class="section">
          <h3>1 — Contact information</h3>
          <div class="row">
            <div class="col">
              <label>Full name *</label>
              <input id="full_name" placeholder="John Doe" />
            </div>
            <div class="col">
              <label>Email *</label>
              <input id="email" placeholder="you@domain.com" />
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Phone</label>
              <input id="phone" placeholder="+1 (555) 123-4567" />
            </div>
            <div class="col">
              <label>Location</label>
              <input id="location" placeholder="City, Country" />
            </div>
          </div>

          <div class="section">
            <label>LinkedIn (optional)</label>
            <input id="linkedin" placeholder="https://linkedin.com/..." />
          </div>
        </div>

        <div class="section">
          <h3>2 — Work Experience</h3>
          <button id="btn-add-work" class="small-btn">+ Add Work</button>
          <div id="work-list" style="margin-top:12px;color:rgba(255,255,255,0.85)">No work entries yet.</div>
        </div>

        <div class="section">
          <h3>3 — Education</h3>
          <button id="btn-add-edu" class="small-btn">+ Add Education</button>
          <div id="edu-list" style="margin-top:12px;color:rgba(255,255,255,0.85)">No education entries yet.</div>
        </div>

        <div class="section">
          <h3>4 — Certifications</h3>
          <button id="btn-add-cert" class="small-btn">+ Add Cert</button>
          <div id="cert-list" style="margin-top:12px;color:rgba(255,255,255,0.85)">No certifications yet.</div>
        </div>

        <div class="submit-wrap">
          <button id="btn-submit" class="btn-primary">Submit</button>
        </div>

        <div class="muted">All fields marked * are mandatory.</div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="common.js"></script>
  <script>
    // Home page logic: load profile, fill fields, show lists
    (async function initHome(){
      const user = await App.getUser();
      if(!user){
        // not logged in: redirect to login
        window.location.href = 'login.html';
        return;
      }
      document.querySelector('.topbar h2').textContent = 'Resume Builder — Home';
      document.querySelector('#btn-logout').onclick = async () => {
        await App.signOut();
      };

      document.querySelector('#btn-edit').onclick = () => {
        // focus the form (we are already on home)
        document.querySelector('#full_name').focus();
      }

      // load profile row
      const { data: profile, error } = await App.getProfile(user.id);
      if(profile){
        document.getElementById('full_name').value = App.esc(profile.full_name);
        document.getElementById('phone').value = App.esc(profile.phone);
        document.getElementById('location').value = App.esc(profile.location);
        document.getElementById('linkedin').value = App.esc(profile.linkedin);
        document.getElementById('email').value = user.email || '';
        // show profile JSON for debugging (toggle)
        document.getElementById('profileJSON').textContent = JSON.stringify(profile, null, 2);
        document.getElementById('btn-submit').textContent = 'Edit profile';
      } else {
        document.getElementById('email').value = user.email || '';
        document.getElementById('profileJSON').textContent = '// No profile data yet';
        document.getElementById('btn-submit').textContent = 'Submit';
      }

      // load experiences + education lists (simple)
      const exps = await App.listExperiences(user.id);
      renderList('work-list', exps, 'experience');
      const edus = await App.listEducation(user.id);
      renderList('edu-list', edus, 'education');
      document.getElementById('btn-add-work').onclick = addWork;
      document.getElementById('btn-add-edu').onclick = addEducation;
      document.getElementById('btn-add-cert').onclick = addCert;

      document.getElementById('btn-submit').onclick = async () => {
        const payload = {
          id: user.id,
          full_name: document.getElementById('full_name').value || null,
          phone: document.getElementById('phone').value || null,
          location: document.getElementById('location').value || null,
          linkedin: document.getElementById('linkedin').value || null,
          github: null
        };
        const { error } = await App.upsertProfile(payload);
        if (error) return alert('Save error: '+ error.message);
        alert('Profile saved');
        // refresh JSON display
        const { data } = await App.getProfile(user.id);
        document.getElementById('profileJSON').textContent = JSON.stringify(data, null, 2);
        document.getElementById('btn-submit').textContent = 'Edit profile';
      };

      // helpers to render simple lists
      function renderList(elId, items, type){
        const el = document.getElementById(elId);
        if(!items || items.length === 0){
          el.innerHTML = `No ${type} entries yet.`;
          return;
        }
        el.innerHTML = items.map(it => {
          if(type === 'experience'){
            return `<div style="margin-bottom:8px;padding:10px;background:rgba(0,0,0,0.06);border-radius:6px">
              <strong>${it.title || '—'}</strong> at ${it.company || '—'}<br/><small>${it.start_date || ''} — ${it.end_date || 'Present'}</small>
            </div>`;
          } else {
            return `<div style="margin-bottom:8px;padding:10px;background:rgba(0,0,0,0.06);border-radius:6px">
              <strong>${it.degree || it.institution || '—'}</strong><br/><small>${it.start_date || ''} — ${it.end_date || ''}</small>
            </div>`;
          }
        }).join('');
      }

      // add simple modal-like prompts to create items quickly (developer convenience)
      async function addWork(){
        const company = prompt('Company name');
        if(!company) return;
        const title = prompt('Title/Role');
        const start = prompt('Start date (e.g. 2020-01)');
        const end = prompt('End date (optional)');
        const { error } = await App.client.from('experiences').insert([{ user_id: user.id, company, title, start_date: start || null, end_date: end || null}]);
        if(error) return alert('Add work error: ' + error.message);
        const list = await App.listExperiences(user.id);
        renderList('work-list', list, 'experience');
      }
      async function addEducation(){
        const institution = prompt('Institution name');
        if(!institution) return;
        const degree = prompt('Degree (B.Tech, BSc, etc)');
        const start = prompt('Start date (e.g. 2018)');
        const end = prompt('End / Grad date (e.g. 2022)');
        const { error } = await App.client.from('education').insert([{ user_id: user.id, institution, degree, start_date: start || null, end_date: end || null }]);
        if(error) return alert('Add education error: ' + error.message);
        const list = await App.listEducation(user.id);
        renderList('edu-list', list, 'education');
      }
      async function addCert(){
        const name = prompt('Certification name');
        if(!name) return;
        const org = prompt('Issuing organization');
        const { error } = await App.client.from('certifications').insert([{ user_id: user.id, name, organization: org || null }]);
        if(error) return alert('Add cert error: ' + error.message);
        const { data } = await App.client.from('certifications').select('*').eq('user_id', user.id);
        const el = document.getElementById('cert-list');
        if(!data || data.length === 0) el.innerHTML = 'No certifications yet.';
        else el.innerHTML = data.map(c => `<div style="margin-bottom:8px;padding:10px;background:rgba(0,0,0,0.06);border-radius:6px"><strong>${c.name}</strong><br/><small>${c.organization||''}</small></div>`).join('');
      }

    })();
  </script>
</body>
</html>
