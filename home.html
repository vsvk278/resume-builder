<!-- home.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Resume Builder — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="common.js"></script>
  <style>
    html,body{height:100%;margin:0;font-family:Inter, Arial, Helvetica, sans-serif;background:linear-gradient(120deg,#0b4b47,#13d9be);color:#fff}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{width:1100px;max-width:96%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 30px 50px rgba(0,0,0,0.35);padding:28px;color:#fff;display:flex;gap:28px}
    .left{flex:0 0 420px}
    .right{flex:1;padding:6px 12px}
    .header{display:flex;justify-content:space-between;align-items:flex-start}
    .profile-badge{background:linear-gradient(180deg,#12d6bd,#0fb69a);width:36px;height:36px;border-radius:8px;margin-right:12px}
    h2{margin:0 0 6px 0;font-size:20px;font-weight:800}
    .muted{color:rgba(255,255,255,0.9);font-size:13px;margin-bottom:8px}
    .illustr{background:rgba(255,255,255,0.06);border-radius:8px;min-height:220px;display:flex;align-items:center;justify-content:center}
    .illustr .card-box{width:60%;height:60%;background:rgba(255,255,255,0.95);border-radius:6px;opacity:0.95}
    label{display:block;font-size:13px;color:rgba(255,255,255,0.95);margin-top:12px}
    .two{display:flex;gap:12px}
    .two input{flex:1}
    input,textarea{width:100%;padding:12px;border-radius:8px;border:none;background:rgba(255,255,255,0.95);color:#043;font-weight:600}
    textarea{min-height:60px;border-radius:6px}
    .btn{padding:10px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn-edit{background:rgba(255,255,255,0.08);color:#fff}
    .btn-logout{background:#ef4444;color:#fff}
    .btn-submit{background:linear-gradient(180deg,#14d6c0,#06b69f);color:#012;padding:12px 18px;border-radius:20px}
    .small-muted{font-size:13px;color:rgba(255,255,255,0.85)}
    .section-title{font-weight:800;margin-top:18px}
    .right .section{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));padding:14px;border-radius:10px;margin-bottom:14px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="left">
        <div style="display:flex;align-items:center">
          <div class="profile-badge"></div>
          <div>
            <div style="font-weight:800">Resume Builder — Home</div>
            <div id="login-status" class="muted">Not logged in</div>
          </div>
        </div>

        <div class="illustr" style="margin-top:18px">
          <div class="card-box"></div>
        </div>

        <div style="margin-top:12px" id="notes">
          <div class="small-muted">Notes: This is your home page. If you haven't saved your resume profile, fill the form and click Submit. If you already saved details you'll see them prefilled and can click Edit profile to update.</div>
        </div>
      </div>

      <div class="right">
        <div class="header">
          <div>
            <h2>Profile</h2>
            <div id="profile-email" class="muted">Logged in as —</div>
          </div>
          <div style="display:flex;gap:10px">
            <button id="btn-edit-toggle" class="btn btn-edit">Edit profile</button>
            <button id="btn-logout" class="btn btn-logout">Logout</button>
          </div>
        </div>

        <div id="form-area">
          <!-- Contact section -->
          <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800;font-size:18px">1 — Contact information</div>
            </div>

            <div style="margin-top:8px" class="two">
              <div>
                <label>Full name *</label>
                <input id="full_name" placeholder="John Doe" />
              </div>
              <div>
                <label>Email *</label>
                <input id="email" placeholder="email@example.com" />
              </div>
            </div>

            <div style="margin-top:8px" class="two">
              <div>
                <label>Phone</label>
                <input id="phone" placeholder="+1 (555) 123-4567" />
              </div>
              <div>
                <label>Location</label>
                <input id="location" placeholder="City, Country" />
              </div>
            </div>

            <label style="margin-top:10px">LinkedIn (optional)</label>
            <input id="linkedin" placeholder="https://linkedin.com/..." />
          </div>

          <!-- Work Experience -->
          <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800;font-size:18px">2 — Work Experience</div>
              <div><button id="btn-add-work" class="btn btn-edit">+ Add Work</button></div>
            </div>
            <div id="work-list" style="margin-top:12px"></div>
          </div>

          <!-- Education -->
          <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800;font-size:18px">3 — Education</div>
              <div><button id="btn-add-edu" class="btn btn-edit">+ Add Education</button></div>
            </div>
            <div id="edu-list" style="margin-top:12px"></div>
          </div>

          <!-- Certifications -->
          <div class="section">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800;font-size:18px">4 — Certifications</div>
              <div><button id="btn-add-cert" class="btn btn-edit">+ Add Cert</button></div>
            </div>
            <div id="cert-list" style="margin-top:12px"></div>
          </div>

          <div style="display:flex;justify-content:flex-end;margin-top:10px">
            <button id="btn-submit" class="btn btn-submit">Submit</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  appCommon.initSupabase();
  const supabase = appCommon.supabaseClientRef();

  const fld = (id) => document.getElementById(id)
  const statusEl = null

  // local arrays (simple implementation)
  function loadLocal() {
    return JSON.parse(localStorage.getItem('rb_extra') || '{"work":[],"edu":[],"certs":[]}')
  }
  function saveLocal(obj){
    localStorage.setItem('rb_extra', JSON.stringify(obj))
  }

  async function initPage(){
    const userResp = await appCommon.getUser();
    if(!userResp) {
      window.location.href = 'login.html';
      return;
    }
    const user = userResp;
    fld('profile-email').innerText = 'Logged in as ' + user.email
    fld('login-status').innerText = 'Logged in as ' + user.email

    // try to load profile from "profiles" table
    let profileData = null
    try{
      const { data, error } = await supabase.from('profiles').select('*').eq('id', user.id).single()
      if(!error && data) profileData = data
    }catch(e){ /* ignore */ }

    // if no row exists, we'll be in "edit mode" (allow filling)
    if(profileData){
      // prefill
      fld('full_name').value = profileData.full_name || ''
      fld('email').value = user.email || ''
      fld('phone').value = profileData.phone || ''
      fld('location').value = profileData.location || ''
      fld('linkedin').value = profileData.linkedin || ''
      // hide editing initially
      setEditable(false)
      document.getElementById('btn-submit').innerText = 'Save changes'
    } else {
      // new user -> editable
      fld('email').value = user.email || ''
      setEditable(true)
      document.getElementById('btn-submit').innerText = 'Submit'
    }

    // load local experiences/education/certs if any
    const extra = loadLocal()
    renderList('work-list', extra.work, ['company','title','dates','bullets'])
    renderList('edu-list', extra.edu, ['institution','degree','dates','notes'])
    renderList('cert-list', extra.certs, ['name','issuer','date'])
  }

  function setEditable(flag){
    const inputs = document.querySelectorAll('input, textarea')
    inputs.forEach(i=> i.disabled = !flag)
    document.getElementById('btn-submit').style.display = flag ? 'inline-block' : 'none'
    document.getElementById('btn-edit-toggle').innerText = flag ? 'Cancel' : 'Edit profile'
  }

  document.getElementById('btn-edit-toggle').addEventListener('click', ()=>{
    const isEditing = document.getElementById('full_name').disabled === false
    setEditable(!isEditing)
  })

  document.getElementById('btn-logout').addEventListener('click', ()=> appCommon.signOutAndRedirect())

  // Trigger to add simple items to lists (local)
  function renderList(containerId, arr, fields) {
    const cont = fld(containerId)
    if(!arr || arr.length === 0) { cont.innerHTML = '<div class="small-muted">No items added yet.</div>'; return }
    cont.innerHTML = ''
    arr.forEach((it, idx)=>{
      const el = document.createElement('div')
      el.style.marginBottom = '10px'
      el.style.background = 'rgba(255,255,255,0.06)'
      el.style.padding = '12px'
      el.style.borderRadius = '8px'
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
        <div style="font-weight:700">${(it[fields[0]] || fields[0])} ${(it.title?('- '+it.title):'')}</div>
        <div><button data-idx="${idx}" data-c="${containerId}" class="btn btn-edit small-edit">Delete</button></div>
        </div>
        <div style="margin-top:6px;color:rgba(255,255,255,0.85)">${(it.dates||'')}</div>`
      cont.appendChild(el)
    })
    // attach delete handlers
    cont.querySelectorAll('.small-edit').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        const idx = parseInt(ev.currentTarget.dataset.idx)
        const c = ev.currentTarget.dataset.c
        const extra = loadLocal()
        if(c === 'work-list') extra.work.splice(idx,1)
        if(c === 'edu-list') extra.edu.splice(idx,1)
        if(c === 'cert-list') extra.certs.splice(idx,1)
        saveLocal(extra)
        renderList('work-list', extra.work, ['company','title','dates','bullets'])
        renderList('edu-list', extra.edu, ['institution','degree','dates','notes'])
        renderList('cert-list', extra.certs, ['name','issuer','date'])
      })
    })
  }

  document.getElementById('btn-add-work').addEventListener('click', ()=>{
    const company = prompt('Company name')
    if(!company) return
    const title = prompt('Job title') || ''
    const dates = prompt('Dates (e.g. Jan 2020 - Present)') || ''
    const bullets = prompt('Short bullets (newline separated)') || ''
    const extra = loadLocal()
    extra.work.unshift({ company, title, dates, bullets })
    saveLocal(extra)
    renderList('work-list', extra.work, ['company','title','dates','bullets'])
  })

  document.getElementById('btn-add-edu').addEventListener('click', ()=>{
    const inst = prompt('Institution name')
    if(!inst) return
    const degree = prompt('Degree') || ''
    const dates = prompt('Dates') || ''
    const notes = prompt('Notes') || ''
    const extra = loadLocal()
    extra.edu.unshift({ institution:inst, degree, dates, notes })
    saveLocal(extra)
    renderList('edu-list', extra.edu, ['institution','degree','dates','notes'])
  })

  document.getElementById('btn-add-cert').addEventListener('click', ()=>{
    const name = prompt('Certification name')
    if(!name) return
    const issuer = prompt('Issuing organization') || ''
    const date = prompt('Date obtained') || ''
    const extra = loadLocal()
    extra.certs.unshift({ name, issuer, date })
    saveLocal(extra)
    renderList('cert-list', extra.certs, ['name','issuer','date'])
  })

  // Submit / Save profile
  document.getElementById('btn-submit').addEventListener('click', async ()=>{
    const user = await appCommon.getUser()
    if(!user) { window.location.href = 'login.html'; return }
    const payload = {
      id: user.id,
      full_name: fld('full_name').value || null,
      phone: fld('phone').value || null,
      location: fld('location').value || null,
      linkedin: fld('linkedin').value || null,
      github: null
    }
    try{
      const { error } = await supabase.from('profiles').upsert(payload, { returning: 'minimal' })
      if(error) {
        alert('Save error: ' + error.message)
        return
      }
      // keep extra in localStorage (you can migrate to DB tables later)
      alert('Profile saved')
      setEditable(false)
      document.getElementById('btn-submit').innerText = 'Save changes'
    }catch(e){ alert('Save failed') }
  })

  // init on load
  initPage()
</script>
</body>
</html>
