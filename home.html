<!-- After UMD + common.js -->
<script src="common.js"></script>
<script>
(async function(){
  // require auth or go to login
  const user = await Common.requireAuthOrRedirect('login.html');
  if (!user) return;

  // helper to find input by id (tries different candidates)
  const $ = (ids) => {
    if (!Array.isArray(ids)) ids = [ids];
    for (const id of ids) {
      const el = document.getElementById(id) || document.querySelector('[name="'+id+'"]');
      if (el) return el;
    }
    return null;
  };

  // common field ids used in our pages previously
  const fullNameEl = $( ['full_name','su-full','su_name','fullname'] );
  const emailEl = $( ['email','li-email','su-email'] );
  const phoneEl = $( ['phone'] );
  const locationEl = $( ['location'] );
  const linkedinEl = $( ['linkedin'] );

  // load profile from DB if exists
  const { data: profile, error: pErr } = await Common.getProfileById(user.id);
  if (pErr) console.log('profile load error', pErr);

  if (profile) {
    if (fullNameEl) fullNameEl.value = profile.full_name || '';
    if (emailEl) emailEl.value = profile.email || user.email || '';
    if (phoneEl) phoneEl.value = profile.phone || '';
    if (locationEl) locationEl.value = profile.location || '';
    if (linkedinEl) linkedinEl.value = profile.linkedin || '';
  } else {
    if (emailEl) emailEl.value = user.email || '';
  }

  // load experiences & education into small UI lists if you have containers with these ids
  const workContainer = document.getElementById('experiences-list') || document.getElementById('work-list') || document.getElementById('workList');
  const eduContainer = document.getElementById('education-list') || document.getElementById('edu-list') || document.getElementById('eduList');

  if (workContainer) {
    const { data: exps, error } = await Common.listExperiences(user.id);
    if (error) console.log('exps load err', error);
    workContainer.innerHTML = '';
    if (exps && exps.length) {
      exps.forEach(e => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.marginBottom = '8px';
        div.innerHTML = `<strong>${e.title||''}</strong> — ${e.company||''}<br/><small>${e.start_date||''} - ${e.end_date||'Present'}</small>`;
        workContainer.appendChild(div);
      });
    } else {
      workContainer.innerHTML = '<small>No experiences yet.</small>';
    }
  }

  if (eduContainer) {
    const { data: edus, error } = await Common.listEducation(user.id);
    if (error) console.log('edu load err', error);
    eduContainer.innerHTML = '';
    if (edus && edus.length) {
      edus.forEach(d => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.marginBottom = '8px';
        div.innerHTML = `<strong>${d.degree||''}</strong> — ${d.institution||''}<br/><small>${d.start_date||''} - ${d.end_date||''}</small>`;
        eduContainer.appendChild(div);
      });
    } else {
      eduContainer.innerHTML = '<small>No education yet.</small>';
    }
  }

  // Save profile button(s) — tries multiple ids your pages may use
  const saveBtns = Array.from(document.querySelectorAll('#btn-save-profile, #save-profile, [data-save-profile]'));
  saveBtns.forEach(b => b.addEventListener('click', async (ev) => {
    ev.preventDefault();
    const payload = {
      id: user.id,
      full_name: fullNameEl ? fullNameEl.value || null : null,
      email: emailEl ? emailEl.value || null : null,
      phone: phoneEl ? phoneEl.value || null : null,
      location: locationEl ? locationEl.value || null : null,
      linkedin: linkedinEl ? linkedinEl.value || null : null
    };
    const { error } = await Common.upsertProfile(payload);
    if (error) return alert('Save error: ' + error.message);
    alert('Profile saved');
    // reload small lists if present (optional)
  });

  // Add experience handler (if btn exists)
  const addExpBtn = document.getElementById('btn-add-exp') || document.getElementById('btn-add-exp') || document.getElementById('btn-add-work') || document.getElementById('add-work');
  if (addExpBtn) {
    addExpBtn.addEventListener('click', async () => {
      // try to collect fields (fallback: prompt)
      const company = prompt('Company name');
      if (!company) return;
      const title = prompt('Title/Role') || '';
      const start = prompt('Start date (YYYY-MM)') || null;
      const end = prompt('End date (YYYY-MM or empty)') || null;
      const row = { user_id: user.id, company, title, start_date: start, end_date: end };
      const { error } = await Common.insertExperiences([row]);
      if (error) return alert('Add experience error: ' + error.message);
      alert('Experience added — refresh view');
      location.reload();
    });
  }

  // Add education handler
  const addEduBtn = document.getElementById('btn-add-edu') || document.getElementById('btn-add-education') || document.getElementById('add-edu');
  if (addEduBtn) {
    addEduBtn.addEventListener('click', async () => {
      const institution = prompt('Institution') || '';
      if (!institution) return;
      const degree = prompt('Degree') || '';
      const start = prompt('Start date') || null;
      const end = prompt('End date') || null;
      const row = { user_id: user.id, institution, degree, start_date: start, end_date: end };
      const { error } = await Common.replaceEducationForUser(user.id, [row]); // or insert
      if (error) return alert('Add education error: ' + error.message);
      alert('Education added — refresh view');
      location.reload();
    });
  }

  // Logout wiring if button exists anywhere
  const logoutBtns = Array.from(document.querySelectorAll('#btn-logout, #logout, [data-logout]'));
  logoutBtns.forEach(b => b.addEventListener('click', async () => {
    await Common.signOut();
    window.location.href = 'login.html';
  }));

})();
</script>
