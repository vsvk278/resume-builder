<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Resume Builder — Dashboard & Tailoring</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:980px;margin:1.5rem auto;padding:1rem;color:#f1f1f1;background:#0f1720}
    .card{background:#0b1220;border:1px solid #172033;padding:18px;border-radius:10px;margin-bottom:14px}
    input,button,textarea,select{display:block;width:100%;margin:8px 0;padding:10px;border-radius:8px;border:1px solid #233040;background:#071226;color:#fff;box-sizing:border-box}
    button{cursor:pointer;background:#0ea5a4;color:#012;border:0;padding:10px;font-weight:700}
    h1{font-size:26px;margin-bottom:12px}
    h3{margin:8px 0 6px 0}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    .muted{color:#9aa7b2}
    .small{font-size:13px;color:#9aa7b2}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-secondary{background:#334155;color:#fff}
    #llm-output{background:#071226;padding:12px;border-radius:8px;color:#e6eef2; max-height:560px; overflow:auto}
    a{color:#7dd3fc}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0ea5a4;color:#012;font-weight:700}
    .exper-card{background:#071226;padding:12px;border-radius:8px;margin-bottom:8px;border:1px solid #172033}
    .del-btn{background:#ef4444;color:#fff;border:0;padding:6px;border-radius:6px;cursor:pointer}
    pre{white-space:pre-wrap;word-break:break-word}
  </style>
</head>
<body>
  <h1>Resume Builder — Dashboard & Tailoring</h1>

  <!-- AUTH / PROFILE -->
  <div id="auth-forms" class="card">
    <p class="small">Sign up or log in using the other pages (Sign Up / Login). This dashboard requires an authenticated user.</p>
  </div>

  <div id="dashboard" class="card" style="display:none">
    <p>Logged in as <strong><span id="user-email"></span></strong></p>
    <div class="row" style="margin-bottom:12px">
      <button id="btn-logout" class="btn-danger">Logout</button>
      <button id="btn-refresh" class="btn-secondary">Refresh profile</button>
    </div>

    <h3>Your profile (saved to DB)</h3>
    <label>Full name</label>
    <input id="full_name" placeholder="Full name" />
    <label>Phone</label>
    <input id="phone" placeholder="Phone" />
    <label>Location</label>
    <input id="location" placeholder="City, Country" />
    <label>LinkedIn</label>
    <input id="linkedin" placeholder="LinkedIn URL" />
    <label>GitHub</label>
    <input id="github" placeholder="GitHub URL" />
    <button id="btn-save-profile">Save Profile</button>

    <hr />

    <h3>Experience</h3>
    <div id="experience-form" style="margin-bottom:12px">
      <label>Company</label>
      <input id="exp-company" placeholder="Company" />
      <label>Title</label>
      <input id="exp-title" placeholder="Role/Title" />
      <label>Start date</label>
      <input id="exp-start" type="date" />
      <label>End date (or leave blank)</label>
      <input id="exp-end" type="date" />
      <label>Bullets (one per line)</label>
      <textarea id="exp-bullets" placeholder="Achieved X...&#10;Improved Y..." rows="4"></textarea>
      <div class="row">
        <button id="btn-add-exp">Add Experience</button>
        <button id="btn-refresh-exps" class="btn-secondary">Refresh</button>
      </div>
    </div>

    <div id="experiences-list" class="muted"><small>No experiences yet.</small></div>

    <hr />

    <h3>Education</h3>
    <div id="education-form" style="margin-bottom:12px">
      <label>Institution</label>
      <input id="edu-institution" placeholder="College / Univ" />
      <label>Degree</label>
      <input id="edu-degree" placeholder="B.Sc / M.Sc / B.Tech" />
      <label>Start date</label>
      <input id="edu-start" type="date" />
      <label>End date</label>
      <input id="edu-end" type="date" />
      <label>Notes</label>
      <textarea id="edu-notes" placeholder="Any honours / achievements" rows="3"></textarea>
      <div class="row">
        <button id="btn-add-edu">Add Education</button>
        <button id="btn-refresh-edus" class="btn-secondary">Refresh</button>
      </div>
    </div>

    <div id="education-list" class="muted"><small>No education yet.</small></div>

    <p id="status" class="small"></p>
  </div>

  <!-- LLM TAILORING UI -->
  <div class="card">
    <h3>AI Tailoring (user-supplied OpenAI API key)</h3>

    <label>OpenAI API key (paste your key here; stored only in this browser)</label>
    <input id="user-api-key" placeholder="sk-..." />
    <div class="row" style="margin-bottom:8px">
      <button id="btn-save-key">Save Key (browser)</button>
      <button id="btn-clear-key" class="btn-danger">Clear Key</button>
    </div>
    <p id="key-hint" class="small">Key not saved.</p>

    <hr />

    <label>Paste job description</label>
    <textarea id="job-desc" placeholder="Paste the job description here..." style="height:120px"></textarea>

    <div class="row">
      <button id="btn-generate" style="background:#06b6d4;color:#012;">Generate tailored resume</button>
      <button id="btn-copy-output" class="btn-secondary">Copy output (raw JSON)</button>
    </div>

    <p id="llm-status" class="small"></p>

    <h4 style="margin-top:14px">Generated tailored resume (preview)</h4>
    <div id="llm-output"></div>

    <div style="margin-top:10px">
      <button id="btn-print">Print / Save as PDF</button>
    </div>
  </div>

  <!-- Supabase client UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <script>
  // ---------------- CONFIG ----------------
  const SUPABASE_URL = 'https://aisuwbgwhvbikdvoming.supabase.co'
  const SUPABASE_ANON_KEY = 'sb_publishable_OZ2XcYvyUC3cpTUPUXhTig_bH_U1QO7'
  const { createClient } = supabase
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
  // ----------------------------------------

  // UI elements
  const authForms = document.getElementById('auth-forms')
  const dashboard = document.getElementById('dashboard')
  const authMsg = document.getElementById('status')
  const userEmailSpan = document.getElementById('user-email')

  // ----- helpers for API key in browser -----
  const apiKeyInput = document.getElementById('user-api-key')
  const btnSaveKey = document.getElementById('btn-save-key')
  const btnClearKey = document.getElementById('btn-clear-key')
  const keyHint = document.getElementById('key-hint')

  function saveKeyToBrowser(k){
    if(!k) return
    localStorage.setItem('user_llm_api_key', k.trim())
    keyHint.textContent = 'API key saved in this browser (localStorage).'
    apiKeyInput.value = ''
  }
  function clearKeyFromBrowser(){
    localStorage.removeItem('user_llm_api_key')
    keyHint.textContent = 'API key cleared.'
  }
  function getKeyFromBrowser(){
    return localStorage.getItem('user_llm_api_key') || null
  }

  (function(){
    const k = getKeyFromBrowser()
    if(k) keyHint.textContent = 'An API key is saved in this browser (localStorage).'
    else keyHint.textContent = 'No API key saved (paste and Save Key).'
  })()

  btnSaveKey.onclick = ()=> {
    const v = apiKeyInput.value.trim()
    if(!v){ alert('Paste your OpenAI API key (sk-...)'); return }
    saveKeyToBrowser(v)
  }
  btnClearKey.onclick = ()=> {
    if(!confirm('Remove saved API key from this browser?')) return
    clearKeyFromBrowser()
  }

  // ----- Auth & profile logic (same as before) -----
  document.getElementById('btn-logout').onclick = async ()=> {
    await supabaseClient.auth.signOut()
    hideDashboard()
  }

  document.getElementById('btn-save-profile').onclick = async () => {
    authMsg.textContent = 'Saving...'
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) { authMsg.textContent = 'Not authenticated'; return }
    const payload = {
      id: user.id,
      full_name: document.getElementById('full_name').value || null,
      phone: document.getElementById('phone').value || null,
      location: document.getElementById('location').value || null,
      linkedin: document.getElementById('linkedin').value || null,
      github: document.getElementById('github').value || null
    }
    const { error } = await supabaseClient.from('profiles').upsert(payload, { returning: 'minimal' })
    if (error) authMsg.textContent = 'Error: ' + error.message
    else authMsg.textContent = 'Profile saved'
  }

  document.getElementById('btn-refresh').onclick = showDashboard

  async function showDashboard(){
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) return hideDashboard()
    userEmailSpan.textContent = user.email
    authForms.style.display = 'none'
    dashboard.style.display = 'block'

    // profile
    const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single()
    if (error && error.code !== 'PGRST116') console.log('profile select error', error)
    if (data) {
      document.getElementById('full_name').value = data.full_name || ''
      document.getElementById('phone').value = data.phone || ''
      document.getElementById('location').value = data.location || ''
      document.getElementById('linkedin').value = data.linkedin || ''
      document.getElementById('github').value = data.github || ''
    } else {
      document.getElementById('full_name').value = ''
      document.getElementById('phone').value = ''
      document.getElementById('location').value = ''
      document.getElementById('linkedin').value = ''
      document.getElementById('github').value = ''
    }

    await loadExperiences()
    await loadEducation()
  }

  function hideDashboard(){
    authForms.style.display = 'block'
    dashboard.style.display = 'none'
    authMsg.textContent = ''
  }

  supabaseClient.auth.onAuthStateChange((event, session) => {
    if (session && session.user) showDashboard()
    else hideDashboard()
  })

  ;(async ()=> {
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (user) showDashboard()
  })()

  // ----- Experiences / Education -----
  async function loadExperiences(){
    const { data: { user } } = await supabaseClient.auth.getUser()
    const container = document.getElementById('experiences-list')
    if(!user){ container.innerHTML = '<small>Login to see experiences</small>'; return }
    const { data, error } = await supabaseClient.from('experiences').select('*').eq('user_id', user.id).order('created_at', { ascending:false })
    if(error){ console.log('loadExperiences error', error); container.innerHTML = '<small>Error loading experiences</small>'; return }
    if(!data || data.length===0){ container.innerHTML = '<small>No experiences yet.</small>'; return }
    container.innerHTML = data.map(e => {
      const bullets = (e.bullets||'').split('\n').map(b => `<li>${escapeHtml(b)}</li>`).join('')
      return `
        <div class="exper-card">
          <div><strong>${escapeHtml(e.title||'')}</strong> • ${escapeHtml(e.company||'')}
            <span style="float:right;color:#9aa7b2">${escapeHtml(e.start_date || '')} — ${escapeHtml(e.end_date || 'Present')}</span>
          </div>
          <ul style="margin-top:8px">${bullets}</ul>
          <div style="text-align:right"><button data-id="${e.id}" class="del-experience del-btn">Delete</button></div>
        </div>
      `
    }).join('')

    document.querySelectorAll('.del-experience').forEach(btn => {
      btn.onclick = async (ev) => {
        const id = ev.target.dataset.id
        if(!confirm('Delete this experience?')) return
        const { error } = await supabaseClient.from('experiences').delete().eq('id', id)
        if(error) alert('Delete error: ' + error.message)
        else loadExperiences()
      }
    })
  }

  async function loadEducation(){
    const { data: { user } } = await supabaseClient.auth.getUser()
    const container = document.getElementById('education-list')
    if(!user){ container.innerHTML = '<small>Login to see education</small>'; return }
    const { data, error } = await supabaseClient.from('education').select('*').eq('user_id', user.id).order('created_at', { ascending:false })
    if(error){ console.log('loadEducation error', error); container.innerHTML = '<small>Error loading education</small>'; return }
    if(!data || data.length===0){ container.innerHTML = '<small>No education yet.</small>'; return }
    container.innerHTML = data.map(d => {
      return `
        <div class="exper-card">
          <div><strong>${escapeHtml(d.degree||'')}</strong> • ${escapeHtml(d.institution||'')}
            <span style="float:right;color:#9aa7b2">${escapeHtml(d.start_date||'')} — ${escapeHtml(d.end_date||'')}</span>
          </div>
          <div style="margin-top:6px">${escapeHtml(d.notes||'')}</div>
          <div style="text-align:right;margin-top:8px"><button data-id="${d.id}" class="del-edu del-btn">Delete</button></div>
        </div>
      `
    }).join('')

    document.querySelectorAll('.del-edu').forEach(btn => {
      btn.onclick = async (ev) => {
        const id = ev.target.dataset.id
        if(!confirm('Delete this education?')) return
        const { error } = await supabaseClient.from('education').delete().eq('id', id)
        if(error) alert('Delete error: ' + error.message)
        else loadEducation()
      }
    })
  }

  // add experience / education handlers
  document.getElementById('btn-add-exp').onclick = async () => {
    const { data: { user } } = await supabaseClient.auth.getUser()
    if(!user) return alert('Login required')
    const payload = {
      user_id: user.id,
      company: document.getElementById('exp-company').value || null,
      title: document.getElementById('exp-title').value || null,
      start_date: document.getElementById('exp-start').value || null,
      end_date: document.getElementById('exp-end').value || null,
      bullets: document.getElementById('exp-bullets').value || null
    }
    const { error } = await supabaseClient.from('experiences').insert(payload)
    if(error) alert('Error: ' + error.message)
    else { alert('Experience added'); await loadExperiences(); document.getElementById('exp-company').value=''; document.getElementById('exp-title').value=''; document.getElementById('exp-start').value=''; document.getElementById('exp-end').value=''; document.getElementById('exp-bullets').value='' }
  }
  document.getElementById('btn-refresh-exps').onclick = loadExperiences

  document.getElementById('btn-add-edu').onclick = async () => {
    const { data: { user } } = await supabaseClient.auth.getUser()
    if(!user) return alert('Login required')
    const payload = {
      user_id: user.id,
      institution: document.getElementById('edu-institution').value || null,
      degree: document.getElementById('edu-degree').value || null,
      start_date: document.getElementById('edu-start').value || null,
      end_date: document.getElementById('edu-end').value || null,
      notes: document.getElementById('edu-notes').value || null
    }
    const { error } = await supabaseClient.from('education').insert(payload)
    if(error) alert('Error: ' + error.message)
    else { alert('Education added'); await loadEducation(); document.getElementById('edu-institution').value=''; document.getElementById('edu-degree').value=''; document.getElementById('edu-start').value=''; document.getElementById('edu-end').value=''; document.getElementById('edu-notes').value='' }
  }
  document.getElementById('btn-refresh-edus').onclick = loadEducation

  // escape helper
  function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

  // ---------------- LLM JSON + Render flow ----------------

  // render JSON -> styled HTML resume
  function renderResumeJSON(resume){
    const name = resume.name || ''
    const title = resume.title || ''
    const contact = resume.contact || {}
    const summary = resume.summary || ''
    const experiences = resume.experiences || []
    const education = resume.education || []
    const skills = resume.skills || []
    const certs = resume.certifications || []
    const keywords = resume.ats_keywords || []

    const css = `
      <style>
        body{font-family:Inter,Arial,Helvetica,sans-serif;color:#111}
        .resume{max-width:800px;margin:10px auto;padding:28px;background:#fff;color:#111}
        .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
        .name{font-size:22px;font-weight:800}
        .title{font-size:13px;color:#333;margin-top:6px}
        .contact{font-size:12px;color:#333;text-align:right}
        h3{font-size:13px;margin:18px 0 6px 0;color:#111}
        .section{margin-bottom:10px}
        .role{font-weight:700}
        .company{font-weight:600;color:#222}
        .dates{float:right;color:#444;font-size:12px}
        ul{margin:6px 0 12px 18px}
        .bullet{margin-bottom:6px}
        .skills-list{display:flex;flex-wrap:wrap;gap:8px}
        .skill-pill{background:#f1f5f9;padding:6px 8px;border-radius:6px;font-size:12px;color:#111}
        .ats{font-size:12px;color:#222;margin-top:8px}
      </style>
    `

    const contactLines = []
    if(contact.location) contactLines.push(contact.location)
    if(contact.phone) contactLines.push(contact.phone)
    if(contact.email) contactLines.push(contact.email)
    if(contact.linkedin) contactLines.push(`<a href="${contact.linkedin}" target="_blank" rel="noopener">${contact.linkedin.replace(/^https?:\/\//,'')}</a>`)

    const exHtml = experiences.map(e => {
      const bullets = (e.bullets || []).map(b => `<li class="bullet">${escapeHtml(b)}</li>`).join('')
      const dates = (e.start_date || '') + (e.end_date ? ' — ' + e.end_date : ' — Present')
      return `
        <div class="section">
          <div><span class="role">${escapeHtml(e.title || '')}</span> • <span class="company">${escapeHtml(e.company || '')}</span>
            <span class="dates">${escapeHtml(dates)}</span>
          </div>
          <ul>${bullets}</ul>
        </div>
      `
    }).join('')

    const eduHtml = education.map(d => {
      const dates = (d.start_date || '') + (d.end_date ? ' — ' + d.end_date : '')
      return `
        <div class="section">
          <div><span class="role">${escapeHtml(d.degree||'')}</span> • <span class="company">${escapeHtml(d.institution||'')}</span>
            <span class="dates">${escapeHtml(dates)}</span>
          </div>
          <div>${escapeHtml(d.notes||'')}</div>
        </div>
      `
    }).join('')

    const skillsHtml = skills.map(s => `<div class="skill-pill">${escapeHtml(s)}</div>`).join('')
    const certHtml = certs.map(c => `<div>${escapeHtml(c)}</div>`).join('')
    const keywordsText = keywords.join(', ')

    const html = `
      ${css}
      <div class="resume">
        <div class="header">
          <div>
            <div class="name">${escapeHtml(name)}</div>
            <div class="title">${escapeHtml(title)}</div>
          </div>
          <div class="contact">${contactLines.join(' • ')}</div>
        </div>

        <div class="section">
          <h3>Professional Summary</h3>
          <div>${escapeHtml(summary)}</div>
        </div>

        <div>
          <h3>Experience</h3>
          ${exHtml || '<div class="meta">No experiences listed.</div>'}
        </div>

        <div style="margin-top:6px">
          <h3>Education</h3>
          ${eduHtml || '<div class="meta">No education listed.</div>'}
        </div>

        <div style="margin-top:6px">
          <h3>Core Skills</h3>
          <div class="skills-list">${skillsHtml}</div>
        </div>

        <div style="margin-top:6px">
          <h3>Certifications</h3>
          <div>${certHtml || '<div class="meta">None listed.</div>'}</div>
        </div>

        <div style="margin-top:10px">
          <strong>ATS keywords:</strong> <span class="ats">${escapeHtml(keywordsText)}</span>
        </div>
      </div>
    `
    return html
  }

  // Build strict JSON prompt
  async function buildPromptJSON(jobDescription){
    const { data: { user } } = await supabaseClient.auth.getUser()
    if(!user) throw new Error('Not authenticated')

    const [profileRes, expsRes, edusRes] = await Promise.all([
      supabaseClient.from('profiles').select('*').eq('id', user.id).single(),
      supabaseClient.from('experiences').select('*').eq('user_id', user.id).order('created_at', { ascending:false }),
      supabaseClient.from('education').select('*').eq('user_id', user.id).order('created_at', { ascending:false })
    ])

    const profile = profileRes?.data || {}
    const exps = (expsRes?.data || []).map(e => ({
      title: e.title,
      company: e.company,
      start_date: e.start_date,
      end_date: e.end_date,
      bullets: (e.bullets || '').split('\n').map(b => b.trim()).filter(Boolean)
    }))
    const edus = (edusRes?.data || []).map(d => ({
      degree: d.degree, institution: d.institution, start_date: d.start_date, end_date: d.end_date, notes: d.notes
    }))

    const profileText = {
      name: profile.full_name || (user.user_metadata && user.user_metadata.full_name) || '',
      location: profile.location || '',
      phone: profile.phone || '',
      email: user.email || '',
      linkedin: profile.linkedin || '',
      github: profile.github || ''
    }

    const systemInstructions = `
You are an expert resume writer and ATS optimizer.
Given the user's profile and the job description, produce a JSON object only (no extra commentary) with the following exact schema:

{
  "name": "<Full name>",
  "title": "<Target title, e.g., DevOps Engineer>",
  "contact": { "email":"", "phone":"", "location":"", "linkedin":"", "github":"" },
  "summary": "<2-3 sentence targeted professional summary>",
  "experiences": [
    { "title":"", "company":"", "start_date":"YYYY-MM", "end_date":"YYYY-MM or Present", "bullets":["...","..."] }
  ],
  "education": [
    { "degree":"", "institution":"", "start_date":"YYYY-MM or YYYY", "end_date":"YYYY-MM or YYYY", "notes":"" }
  ],
  "skills": ["skill1","skill2", "..."],
  "certifications": ["..."],
  "ats_keywords": ["keyword1","keyword2", "..."]
}

Rules:
- Output valid JSON only. Do not prepend or append any text (no explanation).
- For experiences, include 3-6 bullets per relevant role prioritized by relevance to the Job Description.
- Rewrite bullets to be accomplishment-driven, quantified where possible, and use keywords from the Job Description.
- Keep language concise and professional.
- If info missing, leave fields empty but keep the schema.
    `

    const userContent = { profile: profileText, experiences: exps, education: edus, job_description: jobDescription }
    return { systemInstructions, userContent }
  }

  // Call OpenAI chat completion and render
  async function callLLMandRender(){
    const key = getKeyFromBrowser()
    if(!key) { alert('Save your OpenAI API key in the browser first'); return }
    const jd = document.getElementById('job-desc').value.trim()
    if(!jd) return alert('Paste a job description first.')

    document.getElementById('llm-status').textContent = 'Preparing prompt...'
    const { systemInstructions, userContent } = await buildPromptJSON(jd)

    const messages = [
      { role: 'system', content: systemInstructions },
      { role: 'user', content: JSON.stringify(userContent) }
    ]

    document.getElementById('llm-status').textContent = 'Calling LLM...'
    const model = 'gpt-4o-mini' // change if you want a different model
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify({ model, messages, temperature: 0.1, max_tokens: 1500 })
    })

    if(!resp.ok){
      const t = await resp.text()
      throw new Error('LLM call failed: ' + resp.status + ' ' + t)
    }

    const data = await resp.json()
    const raw = data?.choices?.[0]?.message?.content || data?.choices?.[0]?.text || ''
    let json
    try{ json = JSON.parse(raw) } catch(e){
      const m = raw.match(/\{[\s\S]*\}/)
      if(m) try{ json = JSON.parse(m[0]) } catch(err){ json = null }
    }

    if(!json){
      document.getElementById('llm-status').textContent = 'LLM returned non-JSON — showing raw output'
      document.getElementById('llm-output').innerText = raw
      return
    }

    document.getElementById('llm-status').textContent = 'Done — rendering'
    const html = renderResumeJSON(json)
    document.getElementById('llm-output').innerHTML = html

    // make raw JSON available for copy button
    document.getElementById('btn-copy-output').onclick = async ()=> {
      await navigator.clipboard.writeText(JSON.stringify(json, null, 2))
      alert('Raw JSON copied to clipboard')
    }

    // print button prints the rendered resume (in a new window)
    document.getElementById('btn-print').onclick = () => {
      const w = window.open('', '_blank')
      w.document.write(document.getElementById('llm-output').innerHTML)
      w.document.close()
      w.focus()
      w.print()
    }
  }

  document.getElementById('btn-generate').onclick = async () => {
    try { await callLLMandRender() }
    catch(err){ console.error(err); document.getElementById('llm-status').textContent = 'Error: ' + (err.message || err); alert('Error: ' + (err.message || err)) }
  }
  </script>
</body>
</html>
