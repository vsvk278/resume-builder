<!-- robust page wiring (drop-in replacement for your script) -->
<script>
(async function(){
  // robust getUser normalization helper
  function normalizeUser(resp) {
    if (!resp) return null;
    if (resp.user) return resp.user;
    if (resp.data && resp.data.user) return resp.data.user;
    if (resp.data && resp.data.id) return resp.data; // maybe profile-like
    if (resp.id) return resp; // already a user object
    return null;
  }

  // call requireAuthOrRedirect and normalize
  let authResp;
  try {
    if (!window.Common || typeof Common.requireAuthOrRedirect !== 'function') {
      console.error('Common.requireAuthOrRedirect missing. Make sure common.js is loaded and exposes this function.');
      // If Common missing, redirect to login to avoid blank page:
      // window.location.href = 'login.html';
      return;
    }
    authResp = await Common.requireAuthOrRedirect('login.html');
  } catch (err) {
    console.error('requireAuthOrRedirect threw:', err);
    return;
  }

  const user = normalizeUser(authResp);
  if (!user) {
    // assume requireAuthOrRedirect redirected the user already
    console.warn('No authenticated user found (requireAuthOrRedirect returned empty).');
    return;
  }

  // helper to find input by id/name
  const $ = (ids) => {
    if (!Array.isArray(ids)) ids = [ids];
    for (const id of ids) {
      const el = document.getElementById(id) || document.querySelector('[name="'+id+'"]');
      if (el) return el;
    }
    return null;
  };

  // common field ids used in our pages previously
  const fullNameEl = $( ['full_name','su-full','su_name','fullname'] );
  const emailEl = $( ['email','li-email','su-email'] );
  const phoneEl = $( ['phone'] );
  const locationEl = $( ['location'] );
  const linkedinEl = $( ['linkedin'] );

  // --- load profile (robust) ---
  let profile = null;
  try {
    if (typeof Common.getProfileById === 'function') {
      const res = await Common.getProfileById(user.id);
      // normalise: res may be { data: {...}, error } or the profile directly
      profile = res && (res.data || res.profile || res) ;
      if (res && res.error) console.warn('getProfileById returned error:', res.error);
    } else {
      console.warn('Common.getProfileById not found (skipping profile load).');
    }
  } catch (err) {
    console.error('getProfileById failed:', err);
  }

  // Populate fields if profile exists; otherwise prefill email from auth user
  if (profile) {
    if (fullNameEl) fullNameEl.value = profile.full_name || profile.name || '';
    if (emailEl) emailEl.value = profile.email || user.email || '';
    if (phoneEl) phoneEl.value = profile.phone || '';
    if (locationEl) locationEl.value = profile.location || '';
    if (linkedinEl) linkedinEl.value = profile.linkedin || '';
  } else {
    if (emailEl) emailEl.value = user.email || '';
  }

  // --- load experiences & education into UI lists (if containers present) ---
  const workContainer = document.getElementById('experiences-list') || document.getElementById('work-list') || document.getElementById('workList');
  const eduContainer = document.getElementById('education-list') || document.getElementById('edu-list') || document.getElementById('eduList');

  async function safeListExperiences(uid) {
    if (typeof Common.listExperiences === 'function') {
      try {
        const r = await Common.listExperiences(uid);
        return r && (r.data || r) || [];
      } catch(err) { console.error('listExperiences error', err); return []; }
    }
    return [];
  }
  async function safeListEducation(uid) {
    if (typeof Common.listEducation === 'function') {
      try {
        const r = await Common.listEducation(uid);
        return r && (r.data || r) || [];
      } catch(err) { console.error('listEducation error', err); return []; }
    }
    return [];
  }

  if (workContainer) {
    const exps = await safeListExperiences(user.id);
    workContainer.innerHTML = '';
    if (exps && exps.length) {
      exps.forEach(e => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.marginBottom = '8px';
        const bullets = (e.bullets || '').split('\n').map(b => `<li>${(b||'').replace(/</g,'&lt;')}</li>`).join('');
        div.innerHTML = `<strong>${e.title||''}</strong> — ${e.company||''}<br/><small>${e.start_date||''} - ${e.end_date||'Present'}</small><ul style="margin-top:8px;">${bullets}</ul>`;
        workContainer.appendChild(div);
      });
    } else {
      workContainer.innerHTML = '<small>No experiences yet.</small>';
    }
  }

  if (eduContainer) {
    const edus = await safeListEducation(user.id);
    eduContainer.innerHTML = '';
    if (edus && edus.length) {
      edus.forEach(d => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.marginBottom = '8px';
        div.innerHTML = `<strong>${d.degree||''}</strong> — ${d.institution||''}<br/><small>${d.start_date||''} - ${d.end_date||''}</small>`;
        eduContainer.appendChild(div);
      });
    } else {
      eduContainer.innerHTML = '<small>No education yet.</small>';
    }
  }

  // --- save profile (supports multiple button ids/selectors) ---
  const saveBtns = Array.from(document.querySelectorAll('#btn-save-profile, #save-profile, [data-save-profile]'));
  saveBtns.forEach(b => b.addEventListener('click', async (ev) => {
    ev.preventDefault();
    const payload = {
      id: user.id,
      full_name: fullNameEl ? (fullNameEl.value||null) : null,
      email: emailEl ? (emailEl.value||null) : null,
      phone: phoneEl ? (phoneEl.value||null) : null,
      location: locationEl ? (locationEl.value||null) : null,
      linkedin: linkedinEl ? (linkedinEl.value||null) : null
    };
    if (typeof Common.upsertProfile === 'function') {
      try {
        const r = await Common.upsertProfile(payload);
        if (r && r.error) return alert('Save error: ' + r.error.message);
        alert('Profile saved');
      } catch(err){
        alert('Save failed: ' + (err && err.message || err));
      }
    } else if (typeof Common.saveProfile === 'function') {
      try {
        const r = await Common.saveProfile(payload);
        alert('Profile saved');
      } catch(err){
        alert('Save failed: ' + (err && err.message || err));
      }
    } else {
      alert('Save not implemented in Common.js (no upsertProfile/saveProfile).');
      console.warn('Missing Common.upsertProfile/saveProfile', payload);
    }
  }));

  // --- Add experience handler (if btn exists) ---
  const addExpBtn = document.getElementById('btn-add-exp') || document.getElementById('btn-add-work') || document.getElementById('add-work');
  if (addExpBtn) {
    addExpBtn.addEventListener('click', async () => {
      const company = prompt('Company name');
      if (!company) return;
      const title = prompt('Title/Role') || '';
      const start = prompt('Start date (YYYY-MM)') || null;
      const end = prompt('End date (YYYY-MM or leave empty)') || null;
      const row = { user_id: user.id, company, title, start_date: start, end_date: end };

      // try multiple Common API names
      try {
        if (typeof Common.insertExperiences === 'function') {
          const r = await Common.insertExperiences([row]);
          if (r && r.error) throw r.error;
        } else if (typeof Common.addExperience === 'function') {
          await Common.addExperience(row);
        } else {
          alert('Add-experience helper not found in Common.js. Use the prompts to add to DB manually or implement insertExperiences/addExperience.');
          console.warn('Missing Common.insertExperiences / Common.addExperience', row);
          return;
        }
        alert('Experience added — refresh to see it.');
        location.reload();
      } catch(err) {
        alert('Add experience failed: ' + (err && err.message || err));
        console.error('Add exp error', err);
      }
    });
  }

  // --- Add education handler ---
  const addEduBtn = document.getElementById('btn-add-edu') || document.getElementById('btn-add-education') || document.getElementById('add-edu');
  if (addEduBtn) {
    addEduBtn.addEventListener('click', async () => {
      const institution = prompt('Institution') || '';
      if (!institution) return;
      const degree = prompt('Degree') || '';
      const start = prompt('Start date') || null;
      const end = prompt('End date') || null;
      const row = { user_id: user.id, institution, degree, start_date: start, end_date: end };

      try {
        if (typeof Common.insertEducation === 'function') {
          const r = await Common.insertEducation([row]);
          if (r && r.error) throw r.error;
        } else if (typeof Common.replaceEducationForUser === 'function') {
          const r = await Common.replaceEducationForUser(user.id, [row]);
          if (r && r.error) throw r.error;
        } else {
          alert('Add-education helper not found in Common.js. Implement insertEducation or replaceEducationForUser.');
          console.warn('Missing Common.insertEducation / replaceEducationForUser', row);
          return;
        }
        alert('Education added — refresh to see it.');
        location.reload();
      } catch(err) {
        alert('Add education failed: ' + (err && err.message || err));
        console.error('Add edu error', err);
      }
    });
  }

  // --- Logout wiring if button exists anywhere ---
  const logoutBtns = Array.from(document.querySelectorAll('#btn-logout, #logout, [data-logout]'));
  logoutBtns.forEach(b => b.addEventListener('click', async () => {
    try {
      if (typeof Common.signOut === 'function') await Common.signOut();
      else if (typeof Common.authSignOut === 'function') await Common.authSignOut();
      // fallback: try supabase signOut if available
      if (window.supabase && supabase.auth && typeof supabase.auth.signOut === 'function') {
        await supabase.auth.signOut();
      }
    } catch(err) {
      console.warn('Logout error', err);
    }
    window.location.href = 'login.html';
  }));

})(); // IIFE
</script>
