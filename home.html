<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Resume Builder — Home</title>
<style>
  :root{--bg1:#071b1a; --bg2:#0fb49d; --card:#0b3c39cc; --accent:#06b6d4; --muted:rgba(255,255,255,0.75)}
  html,body{height:100%;margin:0;font-family:Inter, system-ui, Arial, sans-serif}
  body{
    background:linear-gradient(120deg,#0b3e3b 0%, #0fb49d 100%);
    padding:40px; box-sizing:border-box;
  }
  .container{max-width:980px;margin:0 auto}
  .header{display:flex; align-items:center; justify-content:space-between; color:white; margin-bottom:18px}
  .title{font-weight:800;font-size:20px}
  .toolbar{display:flex; gap:10px}
  .btn{padding:8px 12px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
  .btn-edit{background:#06b6d4;color:#042}
  .btn-logout{background:#ef4444;color:white}

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
    border-radius:12px;padding:22px; box-shadow: 0 20px 40px rgba(2,8,23,0.45); color:white;
  }

  h2{margin:0 0 10px 0}
  .hint{color:var(--muted); margin-bottom:12px}

  label{display:block;font-size:13px;color:rgba(255,255,255,0.85); margin-top:14px}
  input[type="text"], input[type="email"], textarea{
    width:100%; padding:12px 14px; border-radius:6px; border:none; margin-top:6px; font-weight:600;
    background: rgba(255,255,255,0.95); color:#082; box-shadow: 0 6px 14px rgba(2,8,23,0.08)
  }

  .two{display:flex; gap:12px}
  .two > *{flex:1}

  .actions{display:flex; justify-content:flex-end; gap:12px; margin-top:20px}
  .btn-primary{background:linear-gradient(180deg,#06b6d4,#00a58f); color:#042; padding:10px 16px; border-radius:8px}

  pre.profile-json{background:#082d2a; color:#cde; padding:12px; border-radius:6px; overflow:auto; max-height:220px}

  /* responsive */
  @media (max-width:860px){
    .two{flex-direction:column}
    .header{flex-direction:column; align-items:flex-start; gap:12px}
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <div class="title">Resume Builder — Home</div>
        <div class="hint" id="login-status">Checking login...</div>
      </div>
      <div class="toolbar">
        <button id="btn-edit" class="btn btn-edit">Edit profile</button>
        <button id="btn-logout" class="btn btn-logout">Logout</button>
      </div>
    </div>

    <div class="card">
      <h2>Profile</h2>
      <div class="hint">Fill contact information, work experience & education — or edit an existing profile.</div>

      <form id="profile-form">
        <label>Full name *</label>
        <input id="full_name" type="text" placeholder="Full name" required />

        <div class="two">
          <div>
            <label>Email *</label>
            <input id="email" type="email" placeholder="you@domain.com" required/>
          </div>
          <div>
            <label>Phone</label>
            <input id="phone" type="text" placeholder="+91 98765..." />
          </div>
        </div>

        <label>Location</label>
        <input id="location" type="text" placeholder="City, Country" />

        <label>LinkedIn</label>
        <input id="linkedin" type="text" placeholder="https://linkedin.com/..." />

        <label>GitHub</label>
        <input id="github" type="text" placeholder="https://github.com/..." />

        <div class="actions">
          <button type="button" id="btn-submit" class="btn-primary btn">Submit</button>
        </div>
      </form>

      <hr style="margin:18px 0;border:none;border-top:1px solid rgba(255,255,255,0.04)">

      <h3>Raw profile (for debugging)</h3>
      <pre id="raw" class="profile-json">Not loaded yet.</pre>
      <div style="margin-top:10px;color:rgba(255,255,255,0.8)">Notes: If you already saved your profile the form will be pre-filled and the Submit button will update changes.</div>
    </div>
  </div>

  <!-- supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    // === use your supabase values (match index.html) ===
    const SUPABASE_URL = 'https://aisuwbgwhvbikdvoming.supabase.co'
    const SUPABASE_ANON_KEY = 'sb_publishable_OZ2XcYvyUC3cpTUPUXhTig_bH_U1QO7'
    // =====================================================

    const { createClient } = supabase
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

    const loginStatus = document.getElementById('login-status')
    const raw = document.getElementById('raw')
    const form = document.getElementById('profile-form')
    const btnSubmit = document.getElementById('btn-submit')
    const btnEdit = document.getElementById('btn-edit')
    const btnLogout = document.getElementById('btn-logout')

    // utility to get current user
    async function getUser(){
      const { data } = await sb.auth.getUser()
      return data.user || null
    }

    // load profile if exists
    async function loadProfile(){
      const user = await getUser()
      if(!user){
        loginStatus.textContent = 'Not logged in'
        raw.textContent = 'No user session. Please login (back at index.html).'
        // optionally redirect to login page
        // location.href = 'index.html'
        return
      }
      loginStatus.textContent = 'Logged in as ' + user.email
      // attempt to read profiles table where id = user's id
      const { data, error } = await sb.from('profiles').select('*').eq('id', user.id).single()
      if(error && error.code !== 'PGRST116'){
        raw.textContent = 'Error loading profile: ' + JSON.stringify(error)
        return
      }
      if(!data){
        raw.textContent = 'No profile saved yet for this user.'
        // keep form blank but fill email
        document.getElementById('email').value = user.email
        btnSubmit.textContent = 'Submit'
        return
      }
      // fill form
      document.getElementById('full_name').value = data.full_name || ''
      document.getElementById('email').value = user.email || ''
      document.getElementById('phone').value = data.phone || ''
      document.getElementById('location').value = data.location || ''
      document.getElementById('linkedin').value = data.linkedin || ''
      document.getElementById('github').value = data.github || ''
      btnSubmit.textContent = 'Save changes'
      raw.textContent = JSON.stringify(data, null, 2)
    }

    // save/update profile
    btnSubmit.addEventListener('click', async ()=>{
      const user = await getUser()
      if(!user){ alert('Not authenticated — please login'); return }
      const payload = {
        id: user.id,
        full_name: document.getElementById('full_name').value || null,
        phone: document.getElementById('phone').value || null,
        location: document.getElementById('location').value || null,
        linkedin: document.getElementById('linkedin').value || null,
        github: document.getElementById('github').value || null
      }
      btnSubmit.disabled = true; btnSubmit.textContent = 'Saving...'
      const { error } = await sb.from('profiles').upsert(payload, { returning: 'representation' })
      btnSubmit.disabled = false
      if(error){ alert('Save error: ' + error.message); btnSubmit.textContent = 'Retry' }
      else { alert('Profile saved'); btnSubmit.textContent = 'Save changes'; loadProfile() }
    })

    // edit button just focuses the form (we keep same page)
    btnEdit.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}))

    // logout
    btnLogout.addEventListener('click', async ()=>{
      await sb.auth.signOut()
      alert('Signed out')
      location.href = 'index.html'
    })

    // auth state change: if user logs out from another tab redirect to index
    sb.auth.onAuthStateChange((event, session) => {
      if(!session || !session.user) location.href = 'index.html'
    })

    // initial load
    (async ()=>{ await loadProfile() })()
  </script>
</body>
</html>
