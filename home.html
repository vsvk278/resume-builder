<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Resume Builder — Home</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;600;800&display=swap');
    body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;height:100vh;background:linear-gradient(120deg,#0f544d,#13c7b3);color:#fff;display:flex;align-items:center;justify-content:center;padding:28px}
    .card{width:min(1000px,96%);background:rgba(255,255,255,0.03);border-radius:12px;padding:28px 30px;box-shadow:0 30px 45px rgba(0,0,0,0.35);backdrop-filter:blur(4px)}
    .top{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    .title{font-weight:800;font-size:22px}
    .controls{display:flex;gap:12px}
    .btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .btn.edit{background:#13c7b3;color:#022}
    .btn.logout{background:#ff6b6b;color:#fff}
    .grid{display:flex;gap:28px}
    .left{flex:0.85}
    .right{flex:1}
    .illustration{height:220px;background:linear-gradient(180deg,#eafffb, #e6fffb);border-radius:8px;opacity:0.08}
    h2.section{font-weight:800;font-size:18px;margin:10px 0 12px}
    label{display:block;font-size:12px;margin:8px 0 6px;color:#e7fff8}
    input[type=text], input[type=email]{width:100%;padding:12px 14px;border-radius:6px;border:none;background:#ffffff;color:#023;font-weight:600}
    .two{display:flex;gap:12px}
    .two > div{flex:1}
    .addBtn{display:inline-block;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.06);cursor:pointer;color:#fff;margin-left:auto}
    .submitWrap{text-align:center;margin-top:18px}
    .submitBtn{padding:12px 28px;border-radius:28px;background:linear-gradient(180deg,#02d3c4,#00b9a7);border:none;color:#012;font-weight:800;cursor:pointer}
    pre.profileJson{background:rgba(255,255,255,0.03);padding:12px;border-radius:6px;overflow:auto;color:#e6fff9}
    .muted{color:rgba(255,255,255,0.85);font-weight:600}
    @media (max-width:880px){ .grid{flex-direction:column} .left,.right{flex:none} .illustration{height:140px} }
  </style>
</head>
<body>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="common.js"></script>

  <div class="card" role="main">
    <div class="top">
      <div>
        <div class="title">Resume Builder — Home</div>
        <div id="logged" class="muted">Not logged in</div>
      </div>
      <div class="controls">
        <button id="btn-edit" class="btn edit">Edit profile</button>
        <button id="btn-logout" class="btn logout">Logout</button>
      </div>
    </div>

    <div class="grid">
      <div class="left">
        <div class="illustration" aria-hidden="true"></div>
        <h2 class="section">Profile</h2>
        <pre id="profile-json" class="profileJson">Loading profile…</pre>
        <div style="margin-top:12px" id="notes" class="muted">This is your home page. Use Edit profile to update details.</div>
      </div>

      <div class="right">
        <h2 class="section">1 — Contact information</h2>

        <div style="display:flex;gap:12px">
          <div style="flex:1">
            <label>Full name *</label>
            <input id="full_name" type="text" />
          </div>
          <div style="flex:1">
            <label>Email *</label>
            <input id="email" type="email" />
          </div>
        </div>

        <div class="two" style="margin-top:10px">
          <div>
            <label>Phone</label>
            <input id="phone" type="text" />
          </div>
          <div>
            <label>Location</label>
            <input id="location" type="text" />
          </div>
        </div>

        <label style="margin-top:10px">LinkedIn (optional)</label>
        <input id="linkedin" type="text" />

        <h2 class="section" style="margin-top:18px">2 — Work Experience <span class="addBtn" id="addWork">+ Add Work</span></h2>
        <div id="work-list"><small class="muted">No work entries yet.</small></div>

        <h2 class="section" style="margin-top:18px">3 — Education <span class="addBtn" id="addEdu">+ Add Education</span></h2>
        <div id="edu-list"><small class="muted">No education entries yet.</small></div>

        <h2 class="section" style="margin-top:18px">4 — Certifications <span class="addBtn" id="addCert">+ Add Cert</span></h2>
        <div id="cert-list"><small class="muted">No certifications yet.</small></div>

        <div class="submitWrap">
          <button id="btn-submit" class="submitBtn">Submit</button>
        </div>
        <div style="margin-top:12px;color:rgba(255,255,255,0.8);font-size:13px">All fields marked * are mandatory.</div>
      </div>
    </div>
  </div>

  <script>
    (async function(){
      // ensure user
      const { data: { user } } = await supabaseClient.auth.getUser();
      if (!user) { location.href = 'login.html'; return; }
      document.getElementById('logged').textContent = 'Logged in as ' + (user.email || user.id);

      // load profile
      async function loadProfile(){
        const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single();
        const pre = document.getElementById('profile-json');
        if (error && error.code !== 'PGRST116') {
          pre.textContent = 'Error loading profile: ' + (error.message||'');
          return;
        }
        if (!data) {
          pre.textContent = JSON.stringify({ id: user.id, email: user.email }, null, 2);
          // clear form for new user
          document.getElementById('full_name').value='';
          document.getElementById('email').value = user.email || '';
          document.getElementById('phone').value=''; document.getElementById('location').value=''; document.getElementById('linkedin').value='';
          document.getElementById('btn-submit').textContent = 'Submit';
        } else {
          pre.textContent = JSON.stringify(data, null, 2);
          document.getElementById('full_name').value = data.full_name || '';
          document.getElementById('email').value = data.email || user.email || '';
          document.getElementById('phone').value = data.phone || '';
          document.getElementById('location').value = data.location || '';
          document.getElementById('linkedin').value = data.linkedin || '';
          document.getElementById('btn-submit').textContent = 'Edit profile';
        }
      }

      await loadProfile();

      // signout / edit handlers
      document.getElementById('btn-logout').onclick = async ()=> { await supabaseClient.auth.signOut(); location.href='login.html'; };
      document.getElementById('btn-edit').onclick = () => { window.scrollTo({top:400,behavior:'smooth'}); };

      // submit/save profile
      document.getElementById('btn-submit').onclick = async () => {
        const payload = {
          id: user.id,
          full_name: document.getElementById('full_name').value || null,
          email: document.getElementById('email').value || null,
          phone: document.getElementById('phone').value || null,
          location: document.getElementById('location').value || null,
          linkedin: document.getElementById('linkedin').value || null
        };
        const { error } = await supabaseClient.from('profiles').upsert(payload, { returning:'minimal' });
        if (error) return alert('Save error: ' + error.message);
        alert('Profile saved');
        await loadProfile();
      };

      // simple add-work/add-edu/add-cert UI (local only, stored in DB optional)
      function createTinyItem(containerId, label, placeholder){
        const container = document.getElementById(containerId);
        const wrapper = document.createElement('div');
        wrapper.style.marginTop='8px';
        wrapper.style.padding='10px';
        wrapper.style.background='rgba(255,255,255,0.02)';
        wrapper.style.borderRadius='6px';
        wrapper.innerHTML = `
          <div style="display:flex;gap:8px">
            <input placeholder="${placeholder}" style="flex:1;padding:8px;border-radius:6px;border:none;background:#fff;color:#023">
            <button style="background:#ff6b6b;border:none;color:#fff;padding:6px 10px;border-radius:6px;margin-left:6px;cursor:pointer">Delete</button>
          </div>
        `;
        container.appendChild(wrapper);
        wrapper.querySelector('button').onclick = ()=> wrapper.remove();
      }

      document.getElementById('addWork').onclick = ()=> createTinyItem('work-list','Work entry','Company — Role — dates');
      document.getElementById('addEdu').onclick = ()=> createTinyItem('edu-list','Education entry','Degree — Institute — dates');
      document.getElementById('addCert').onclick = ()=> createTinyItem('cert-list','Cert entry','Certification name');

    })();
  </script>
</body>
</html>
