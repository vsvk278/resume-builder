<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Resume Builder — Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    /* Page layout & theme (matches other pages) */
    body{font-family:Arial,Helvetica,sans-serif;max-width:920px;margin:2rem auto;padding:1rem;color:#e6eef2;background:#0f1720}
    .card{background:#0b1220;border:1px solid #172033;padding:18px;border-radius:10px;margin-bottom:14px}
    input,button,textarea,select{display:block;width:100%;margin:8px 0;padding:10px;border-radius:8px;border:1px solid #233040;background:#071226;color:#fff;box-sizing:border-box}
    button{cursor:pointer;background:#0ea5a4;color:#012;border:0;padding:10px;font-weight:700}
    h1{font-size:26px;margin-bottom:10px}
    .row{display:flex;gap:10px}
    .row > *{flex:1}
    label{color:#cfe8f0;font-weight:600}
    small{color:#9aa7b2}
    a{color:#7dd3fc}
    .muted{color:#9aa7b2}
    .btn-danger{background:#ef4444;color:#fff}
    .inline-btn{display:inline-block;padding:6px 10px;border-radius:6px;background:#334155;color:#fff;border:0;cursor:pointer}
    #experiences-list .card, #education-list .card{background:transparent;border:1px dashed rgba(190,220,225,0.03);padding:10px}
    #llm-output{white-space:pre-wrap; max-height:540px; overflow:auto; background:#071226;padding:14px;border-radius:8px;border:1px solid #172033}
    .note{font-size:13px;color:#9fb1b6}
  </style>
</head>
<body>
  <h1>Resume Builder — Dashboard</h1>

  <div class="card" id="profile-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <p class="muted">Logged in as <strong id="user-email">...</strong></p>
      </div>
      <div style="display:flex;gap:8px">
        <button id="btn-logout" class="btn-danger">Logout</button>
        <button id="btn-refresh" style="background:#06b6d4;color:#012">Refresh</button>
      </div>
    </div>

    <h3>Your profile (saved to DB)</h3>
    <label>Full name</label>
    <input id="full_name" placeholder="Full name" />
    <label>Phone</label>
    <input id="phone" placeholder="Phone" />
    <label>Location</label>
    <input id="location" placeholder="City, Country" />
    <label>LinkedIn</label>
    <input id="linkedin" placeholder="LinkedIn URL" />
    <label>GitHub</label>
    <input id="github" placeholder="GitHub URL" />
    <div class="row">
      <button id="btn-save-profile">Save Profile</button>
      <button id="btn-delete-profile" class="btn-danger">Delete Profile</button>
    </div>
    <p id="status" class="muted"></p>
  </div>

  <div class="card">
    <h3>Experience</h3>
    <label>Company</label><input id="exp-company" placeholder="Company" />
    <label>Title</label><input id="exp-title" placeholder="Role/Title" />
    <div class="row">
      <div>
        <label>Start date</label><input id="exp-start" type="date" />
      </div>
      <div>
        <label>End date (or leave blank)</label><input id="exp-end" type="date" />
      </div>
    </div>
    <label>Bullets (one per line)</label><textarea id="exp-bullets" placeholder="Achieved X...&#10;Improved Y..."></textarea>
    <div class="row">
      <button id="btn-add-exp">Add Experience</button>
      <button id="btn-refresh-exps" style="background:#334155">Refresh</button>
    </div>
    <div id="experiences-list" style="margin-top:12px"><small>No experiences yet.</small></div>
  </div>

  <div class="card">
    <h3>Education</h3>
    <label>Institution</label><input id="edu-institution" placeholder="College / Univ" />
    <label>Degree</label><input id="edu-degree" placeholder="B.Sc / M.Sc / B.Tech" />
    <div class="row">
      <div><label>Start date</label><input id="edu-start" type="date" /></div>
      <div><label>End date</label><input id="edu-end" type="date" /></div>
    </div>
    <label>Notes</label><textarea id="edu-notes" placeholder="Any honours / achievements"></textarea>
    <div class="row">
      <button id="btn-add-edu">Add Education</button>
      <button id="btn-refresh-edus" style="background:#334155">Refresh</button>
    </div>
    <div id="education-list" style="margin-top:12px"><small>No education yet.</small></div>
  </div>

  <div class="card" id="llm-section">
    <h3>AI Tailoring (user key stored in browser)</h3>
    <label>OpenAI API key</label>
    <input id="user-api-key" placeholder="sk-..." />
    <div class="row">
      <button id="btn-save-key">Save Key (browser)</button>
      <button id="btn-clear-key" class="btn-danger">Clear Key</button>
    </div>
    <small id="key-hint" class="muted">Key stored in localStorage for this browser only.</small>

    <hr style="border:none;border-top:1px solid #233040;margin:12px 0" />

    <label>Paste job description</label>
    <textarea id="job-desc" placeholder="Paste the job description here..." style="height:120px"></textarea>
    <div class="row">
      <button id="btn-generate" style="background:#06b6d4;color:#012">Generate tailored resume</button>
      <button id="btn-copy-output" style="background:#334155">Copy output</button>
    </div>
    <p id="llm-status" class="muted"></p>

    <h4 style="margin-top:12px">Generated tailored resume (preview)</h4>
    <div id="llm-output" class="card" style="background:#071226;"></div>
    <div style="margin-top:8px"><button id="btn-print">Print / Save as PDF</button></div>
  </div>

  <!-- Supabase UMD library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

  <!-- Resume styling template for rendered output -->
  <style id="resume-styles">
    .resume{background:#071226;color:#e6eef2;padding:22px;border-radius:8px;font-family:Arial,Helvetica,sans-serif;line-height:1.3}
    .resume .header{display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
    .resume h1{margin:0;font-size:22px;color:#fff}
    .resume h2{margin:4px 0 12px 0;font-size:14px;color:#bfe7ea;font-weight:600}
    .resume .contact{text-align:right;font-size:13px;color:#bcd3d8}
    .section{margin-top:16px}
    .section h3{margin:0 0 8px 0;font-size:15px;border-bottom:1px solid rgba(190,220,225,0.06);padding-bottom:6px;color:#cfe8f0}
    .exp-item{margin:10px 0}
    .exp-item .top{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .exp-item .role{font-weight:700;color:#e8f6f7}
    .exp-item .company{color:#bcd3d8}
    .exp-item .dates{color:#9fb1b6;font-size:13px}
    .exp-item ul{margin:8px 0 0 18px}
    .kv{display:inline-block;margin-right:10px;color:#bcd3d8;font-size:13px}
    .ats{margin-top:8px;font-size:13px;color:#cfe8f0}
  </style>

  <script>
  // ------------------------- CONFIG -------------------------
  const SUPABASE_URL = 'https://aisuwbgwhvbikdvoming.supabase.co'
  const SUPABASE_ANON_KEY = 'sb_publishable_OZ2XcYvyUC3cpTUPUXhTig_bH_U1QO7'
  const { createClient } = supabase
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

  // DOM references
  const userEmailSpan = document.getElementById('user-email')
  const status = document.getElementById('status')
  const llmStatus = document.getElementById('llm-status')
  const llmOutput = document.getElementById('llm-output')

  // ------------------- PROTECTED ROUTE: require auth -------------------
  (async function requireAuth(){
    // on page load, check user; if not present, redirect to login.html
    try{
      const { data: { user } } = await supabaseClient.auth.getUser()
      if (!user) {
        // preserve possible referrer or just go to login
        window.location.href = 'login.html'
        return
      }
      // user exists -> show email + load profile + data
      userEmailSpan.textContent = user.email
      await showDashboard()
    } catch (err) {
      console.error('Auth check error', err)
      window.location.href = 'login.html'
    }
  })()

  // ------------------- Profile functions -------------------
  document.getElementById('btn-save-profile').onclick = async () => {
    status.textContent = 'Saving...'
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) { status.textContent = 'Not authenticated'; return }
    const payload = {
      id: user.id,
      full_name: document.getElementById('full_name').value || null,
      phone: document.getElementById('phone').value || null,
      location: document.getElementById('location').value || null,
      linkedin: document.getElementById('linkedin').value || null,
      github: document.getElementById('github').value || null
    }
    const { error } = await supabaseClient.from('profiles').upsert(payload, { returning: 'minimal' })
    if (error) status.textContent = 'Error: ' + error.message
    else status.textContent = 'Profile saved'
  }

  document.getElementById('btn-delete-profile').onclick = async () => {
    if (!confirm('Delete profile data? This will not delete your user account.')) return
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) return
    const { error } = await supabaseClient.from('profiles').delete().eq('id', user.id)
    if (error) status.textContent = 'Delete error: ' + error.message
    else {
      status.textContent = 'Profile deleted'
      // clear inputs
      ['full_name','phone','location','linkedin','github'].forEach(id => document.getElementById(id).value = '')
    }
  }

  document.getElementById('btn-logout').onclick = async () => {
    await supabaseClient.auth.signOut()
    // clear any stored LLM key (optionally)
    //localStorage.removeItem('user_llm_api_key')
    window.location.href = 'login.html'
  }

  document.getElementById('btn-refresh').onclick = showDashboard

  async function showDashboard(){
    status.textContent = 'Loading...'
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) { window.location.href = 'login.html'; return }
    userEmailSpan.textContent = user.email
    // load profile
    const { data, error } = await supabaseClient.from('profiles').select('*').eq('id', user.id).single()
    if (error && error.code !== 'PGRST116') console.log('select error', error)
    if (data) {
      document.getElementById('full_name').value = data.full_name || ''
      document.getElementById('phone').value = data.phone || ''
      document.getElementById('location').value = data.location || ''
      document.getElementById('linkedin').value = data.linkedin || ''
      document.getElementById('github').value = data.github || ''
    } else {
      ['full_name','phone','location','linkedin','github'].forEach(id=>document.getElementById(id).value = '')
    }
    // load experiences & education
    await loadExperiences()
    await loadEducation()
    status.textContent = ''
  }

  // ------------------- Experiences -------------------
  async function loadExperiences(){
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) { document.getElementById('experiences-list').innerHTML = '<small>Login to see experiences</small>'; return }
    const { data, error } = await supabaseClient.from('experiences').select('*').eq('user_id', user.id).order('created_at', { ascending:false })
    if (error) { console.log('loadExperiences error', error); return }
    if (!data || data.length === 0) { document.getElementById('experiences-list').innerHTML = '<small>No experiences yet.</small>'; return }
    const html = data.map(e => {
      const bullets = (e.bullets||'').split('\n').map(b => `<li>${escapeHtml(b)}</li>`).join('')
      return `<div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div><strong>${escapeHtml(e.title||'')}</strong><div class="muted">${escapeHtml(e.company||'')}</div></div>
          <div class="muted">${escapeHtml(e.start_date||'')} — ${escapeHtml(e.end_date||'Present')}</div>
        </div>
        <ul style="margin-top:8px">${bullets}</ul>
        <div style="margin-top:8px"><button data-id="${e.id}" class="btn-del-exp btn-danger">Delete</button></div>
      </div>`
    }).join('')
    document.getElementById('experiences-list').innerHTML = html
    document.querySelectorAll('.btn-del-exp').forEach(btn => btn.onclick = async (ev) => {
      const id = ev.target.dataset.id
      if (!confirm('Delete this experience?')) return
      const { error } = await supabaseClient.from('experiences').delete().eq('id', id)
      if (error) alert('Delete error: ' + error.message)
      else loadExperiences()
    })
  }

  document.getElementById('btn-add-exp').onclick = async () => {
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) return alert('Login required')
    const payload = {
      user_id: user.id,
      company: document.getElementById('exp-company').value || null,
      title: document.getElementById('exp-title').value || null,
      start_date: document.getElementById('exp-start').value || null,
      end_date: document.getElementById('exp-end').value || null,
      bullets: document.getElementById('exp-bullets').value || null
    }
    const { error } = await supabaseClient.from('experiences').insert(payload)
    if (error) alert('Error: ' + error.message)
    else {
      alert('Experience added')
      await loadExperiences()
      ['exp-company','exp-title','exp-start','exp-end','exp-bullets'].forEach(id=>document.getElementById(id).value = '')
    }
  }
  document.getElementById('btn-refresh-exps').onclick = loadExperiences

  // ------------------- Education -------------------
  async function loadEducation(){
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) { document.getElementById('education-list').innerHTML = '<small>Login to see education</small>'; return }
    const { data, error } = await supabaseClient.from('education').select('*').eq('user_id', user.id).order('created_at', { ascending:false })
    if (error) { console.log('loadEducation error', error); return }
    if (!data || data.length === 0) { document.getElementById('education-list').innerHTML = '<small>No education yet.</small>'; return }
    const html = data.map(e => {
      return `<div class="card">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div><strong>${escapeHtml(e.degree||'')}</strong><div class="muted">${escapeHtml(e.institution||'')}</div></div>
          <div class="muted">${escapeHtml(e.start_date||'')} — ${escapeHtml(e.end_date||'')}</div>
        </div>
        <div style="margin-top:8px">${escapeHtml(e.notes||'')}</div>
        <div style="margin-top:8px"><button data-id="${e.id}" class="btn-del-edu btn-danger">Delete</button></div>
      </div>`
    }).join('')
    document.getElementById('education-list').innerHTML = html
    document.querySelectorAll('.btn-del-edu').forEach(btn => btn.onclick = async (ev) => {
      const id = ev.target.dataset.id
      if (!confirm('Delete this education?')) return
      const { error } = await supabaseClient.from('education').delete().eq('id', id)
      if (error) alert('Delete error: ' + error.message)
      else loadEducation()
    })
  }

  document.getElementById('btn-add-edu').onclick = async () => {
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) return alert('Login required')
    const payload = {
      user_id: user.id,
      institution: document.getElementById('edu-institution').value || null,
      degree: document.getElementById('edu-degree').value || null,
      start_date: document.getElementById('edu-start').value || null,
      end_date: document.getElementById('edu-end').value || null,
      notes: document.getElementById('edu-notes').value || null
    }
    const { error } = await supabaseClient.from('education').insert(payload)
    if (error) alert('Error: ' + error.message)
    else {
      alert('Education added')
      await loadEducation()
      ['edu-institution','edu-degree','edu-start','edu-end','edu-notes'].forEach(id=>document.getElementById(id).value = '')
    }
  }
  document.getElementById('btn-refresh-edus').onclick = loadEducation

  // ------------------- Helpers -------------------
  function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

  // ------------------- LLM / Resume generation -------------------
  const apiKeyInput = document.getElementById('user-api-key')
  const btnSaveKey = document.getElementById('btn-save-key')
  const btnClearKey = document.getElementById('btn-clear-key')
  const keyHint = document.getElementById('key-hint')
  // persist key in localStorage
  function saveKeyToBrowser(k){
    if(!k) return
    localStorage.setItem('user_llm_api_key', k.trim())
    keyHint.textContent = 'API key saved in browser localStorage.'
    apiKeyInput.value = ''
  }
  function clearKeyFromBrowser(){
    localStorage.removeItem('user_llm_api_key')
    keyHint.textContent = 'Key cleared from browser.'
  }
  function getKeyFromBrowser(){ return localStorage.getItem('user_llm_api_key') || null }

  (function initKeyHint(){
    if(getKeyFromBrowser()){
      apiKeyInput.placeholder = 'API key saved (not shown)'
      keyHint.textContent = 'An API key is saved in this browser (use Clear Key to remove).'
    }
  })()

  btnSaveKey.onclick = ()=> {
    const v = apiKeyInput.value.trim()
    if(!v){ alert('Paste your OpenAI API key (sk-...)'); return }
    saveKeyToBrowser(v)
  }
  btnClearKey.onclick = ()=> {
    if(!confirm('Remove saved API key from this browser?')) return
    clearKeyFromBrowser()
  }

  // Print / Save as PDF
  document.getElementById('btn-print').onclick = () => {
    const html = `<html><head><title>Tailored Resume</title><meta name="viewport" content="width=device-width,initial-scale=1" /></head><body style="font-family: Arial; padding:20px; background:#fff; color:#000">${llmOutput.innerHTML}</body></html>`
    const w = window.open('', '_blank')
    w.document.write(html)
    w.document.close()
    w.focus()
    w.print()
  }

  // Copy output
  document.getElementById('btn-copy-output').onclick = async () => {
    const text = llmOutput.innerText || llmOutput.textContent || ''
    if(!text) return alert('No output to copy')
    await navigator.clipboard.writeText(text)
    alert('Copied to clipboard')
  }

  // Build JSON-only prompt (structured)
  async function buildPromptJSON(jobDescription){
    const { data: { user } } = await supabaseClient.auth.getUser()
    if (!user) throw new Error('Not authenticated')
    const [profileRes, expsRes, edusRes] = await Promise.all([
      supabaseClient.from('profiles').select('*').eq('id', user.id).single(),
      supabaseClient.from('experiences').select('*').eq('user_id', user.id).order('created_at', { ascending:false }),
      supabaseClient.from('education').select('*').eq('user_id', user.id).order('created_at', { ascending:false })
    ])
    const profile = profileRes?.data || {}
    const exps = expsRes?.data || []
    const edus = edusRes?.data || []

    let resumeSnapshot = `Name: ${profile.full_name || ''}\nLocation: ${profile.location || ''}\nPhone: ${profile.phone || ''}\nEmail: ${user.email}\nLinkedIn: ${profile.linkedin || ''}\nGitHub: ${profile.github || ''}\n\nExperience:\n`
    for(const e of exps){
      resumeSnapshot += `- ${e.title || ''} at ${e.company || ''} (${e.start_date || ''} - ${e.end_date || 'Present'})\n`
      if(e.bullets) resumeSnapshot += e.bullets.split('\n').map(b=>`  * ${b}`).join('\n') + '\n'
    }
    resumeSnapshot += '\nEducation:\n'
    for(const d of edus){
      resumeSnapshot += `- ${d.degree || ''} at ${d.institution || ''} (${d.start_date || ''} - ${d.end_date || ''})\n`
    }

    const instruction = `
You are an expert resume writer and ATS specialist. Based on the user's resume snapshot and the Job Description below, produce a JSON object only (no additional explanation, no markdown).
The JSON must match this exact schema:

{
  "name": "Full Name",
  "title": "Target Job Title (1-4 words)",
  "contact": { "location": "...", "phone": "...", "email": "...", "linkedin": "...", "github": "..." },
  "summary": "2-4 sentence targeted summary (include top keywords from JD)",
  "experience": [
    { "title":"Senior DevOps Engineer","company":"Acme","dates":"Aug 2021 - May 2023","bullets":["...","..."] }
  ],
  "education":[ { "degree":"...","institution":"...","dates":"..." } ],
  "skills":["skill1","skill2"],
  "certifications":["cert1"],
  "ats_keywords":["keyword1","keyword2"]
}

Rules:
- Return valid JSON only (top-level object). No commentary.
- Use 3-6 bullets per relevant role; rewrite bullets as accomplishment-driven and include JD keywords.
- Keep summary concise and tailored to the Job Description.
- If missing details, infer reasonably but do not fabricate credentials.

User snapshot:
${resumeSnapshot}

Job Description:
${jobDescription}

Return the JSON now.
`.trim()

    return instruction
  }

  // Call LLM (OpenAI Chat Completions) and render
  async function callLLMAndRender(promptText){
    const key = getKeyFromBrowser()
    if(!key) throw new Error('Missing API key. Save your API key first.')
    llmStatus.textContent = 'Calling LLM... (this may take several seconds)'
    llmOutput.textContent = ''
    const body = {
      model: 'gpt-4o-mini',
      messages: [{ role:'user', content: promptText }],
      temperature: 0.15,
      max_tokens: 1400
    }
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST',
      headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${key}` },
      body: JSON.stringify(body)
    })
    if(!resp.ok){
      const txt = await resp.text()
      throw new Error(`LLM error ${resp.status}: ${txt}`)
    }
    const data = await resp.json()
    const content = data?.choices?.[0]?.message?.content || data?.choices?.[0]?.text
    if(!content) throw new Error('No content returned from model')
    // parse JSON
    let parsed = null
    try {
      const cleaned = content.trim().replace(/^```json\s*/,'').replace(/```$/,'').trim()
      parsed = JSON.parse(cleaned)
    } catch (err) {
      llmStatus.textContent = 'LLM returned non-JSON. See console.'
      llmOutput.textContent = content
      console.error('Failed to parse JSON:', content, err)
      throw new Error('Failed to parse JSON from LLM output (open console to inspect)')
    }
    llmStatus.textContent = 'Rendering tailored resume...'
    renderTailoredResume(parsed)
    llmStatus.textContent = 'Done.'
  }

  // Render the parsed JSON to styled HTML
  function renderTailoredResume(obj){
    const container = document.getElementById('llm-output')
    container.innerHTML = ''
    const wrapper = document.createElement('div')
    wrapper.className = 'resume'

    // header
    const header = document.createElement('div'); header.className = 'header'
    const left = document.createElement('div')
    const name = document.createElement('h1'); name.textContent = obj.name || ''
    const title = document.createElement('h2'); title.textContent = obj.title || ''
    left.appendChild(name); left.appendChild(title)
    const right = document.createElement('div'); right.className = 'contact'
    if(obj.contact){
      const c = obj.contact
      if(c.location) right.appendChild(Object.assign(document.createElement('div'),{textContent:c.location}))
      const contactLine = document.createElement('div'); contactLine.textContent = ((c.phone||'') + (c.email?` • ${c.email}`:'')).trim()
      right.appendChild(contactLine)
      if(c.linkedin) right.appendChild(Object.assign(document.createElement('div'),{innerHTML:`<a href="${c.linkedin}" target="_blank" style="color:#9fe9f0">${c.linkedin}</a>`}))
    }
    header.appendChild(left); header.appendChild(right)
    wrapper.appendChild(header)

    // summary
    if(obj.summary){
      const ssec = document.createElement('div'); ssec.className='section'
      ssec.innerHTML = `<h3>Summary</h3><div style="margin-top:8px">${escapeHtml(obj.summary)}</div>`
      wrapper.appendChild(ssec)
    }

    // experience
    if(Array.isArray(obj.experience) && obj.experience.length){
      const esec = document.createElement('div'); esec.className='section'; esec.innerHTML = '<h3>Experience</h3>'
      for(const e of obj.experience){
        const item = document.createElement('div'); item.className='exp-item'
        const top = document.createElement('div'); top.className='top'
        const leftTop = document.createElement('div')
        const role = document.createElement('div'); role.className='role'; role.textContent = e.title || ''
        const company = document.createElement('div'); company.className='company'; company.textContent = e.company || ''
        leftTop.appendChild(role); leftTop.appendChild(company)
        const dates = document.createElement('div'); dates.className='dates'; dates.textContent = e.dates || ''
        top.appendChild(leftTop); top.appendChild(dates)
        item.appendChild(top)
        if(Array.isArray(e.bullets) && e.bullets.length){
          const ul = document.createElement('ul')
          for(const b of e.bullets){
            const li = document.createElement('li'); li.innerHTML = escapeHtml(b)
            ul.appendChild(li)
          }
          item.appendChild(ul)
        }
        esec.appendChild(item)
      }
      wrapper.appendChild(esec)
    }

    // education
    if(Array.isArray(obj.education) && obj.education.length){
      const esec = document.createElement('div'); esec.className='section'; esec.innerHTML = '<h3>Education</h3>'
      for(const d of obj.education){
        const div = document.createElement('div'); div.style.marginTop='8px'
        div.innerHTML = `<strong>${escapeHtml(d.degree || '')}</strong> — ${escapeHtml(d.institution || '')}`
        const dates = document.createElement('div'); dates.className='dates'; dates.textContent = d.dates || ''
        div.appendChild(dates)
        if(d.notes) div.appendChild(Object.assign(document.createElement('div'),{style:'margin-top:6px', textContent: d.notes}))
        esec.appendChild(div)
      }
      wrapper.appendChild(esec)
    }

    // skills & certifications & ATS
    if(Array.isArray(obj.skills) && obj.skills.length){
      const s = document.createElement('div'); s.className='section'; s.innerHTML = '<h3>Skills</h3>'
      s.innerHTML += `<div style="margin-top:8px">${obj.skills.map(x=>`<span class="kv">${escapeHtml(x)}</span>`).join(' ')}</div>`
      wrapper.appendChild(s)
    }
    if(Array.isArray(obj.certifications) && obj.certifications.length){
      const c = document.createElement('div'); c.className='section'; c.innerHTML = '<h3>Certifications</h3>'
      c.innerHTML += `<div style="margin-top:8px">${obj.certifications.map(x=>`<div class="kv">${escapeHtml(x)}</div>`).join('')}</div>`
      wrapper.appendChild(c)
    }
    if(Array.isArray(obj.ats_keywords) && obj.ats_keywords.length){
      const a = document.createElement('div'); a.className='section'
      a.innerHTML = '<h3>ATS keywords</h3><div class="ats">'+ obj.ats_keywords.map(k=>escapeHtml(k)).join(' • ') + '</div>'
      wrapper.appendChild(a)
    }

    container.appendChild(wrapper)
  }

  // escape helper
  function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

  // connect generate button
  document.getElementById('btn-generate').onclick = async () => {
    try{
      const jd = document.getElementById('job-desc').value.trim()
      if(!jd) return alert('Paste a job description first.')
      llmStatus.textContent = 'Preparing prompt...'
      const prompt = await buildPromptJSON(jd)
      await callLLMAndRender(prompt)
    } catch (err) {
      console.error(err)
      alert('Error: ' + (err.message || err))
      llmStatus.textContent = 'Error: ' + (err.message || '')
    }
  }

  // quick save/load key: Enter saves
  apiKeyInput.addEventListener('keydown', (e)=> { if(e.key === 'Enter'){ e.preventDefault(); btnSaveKey.click() } })
  </script>
</body>
</html>
